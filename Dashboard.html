<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Mutual Transfer | Premium Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --success: #059669;
            --warning: #f59e0b;
            --danger: #dc2626;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        body {
            background: var(--bg);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-main);
            transition: all 0.3s ease;
        }

        /* --- Smooth Loading Animations --- */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* --- Robust UI Elements --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 1000;
        }

        .main-card {
            background: var(--surface);
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
            transition: transform 0.2s;
        }

        .filter-pill {
            border-radius: 12px;
            border: 1.5px solid #e2e8f0;
            padding: 10px 15px;
            font-weight: 600;
            font-size: 0.85rem;
            width: 100%;
            background: white;
        }

        /* --- My Post Highlighting --- */
        .my-post-glow {
            border: 2px solid var(--primary) !important;
            background: var(--primary-light) !important;
            position: relative;
            overflow: hidden;
        }
        
        .my-post-glow::after {
            content: "YOUR LISTING";
            position: absolute;
            top: 10px; right: -30px;
            background: var(--primary);
            color: white;
            font-size: 0.6rem;
            font-weight: 900;
            padding: 5px 40px;
            transform: rotate(45deg);
        }

        /* --- Custom Badges --- */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
        }
        .badge-pending { background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }
        .badge-match { background: #dcfce7; color: #15803d; }
        .badge-3way { background: #dbeafe; color: #1d4ed8; }

        .btn-unlock {
            background: var(--primary);
            color: white;
            border-radius: 10px;
            font-weight: 700;
            padding: 8px 18px;
            border: none;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        #emptyState { display: none; text-align: center; padding: 50px; }
    </style>
</head>
<body>

<div class="glass-header py-3 mb-4">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <div class="bg-primary text-white p-2 rounded-lg mr-3 shadow-sm">
                <i class="fas fa-exchange-alt"></i>
            </div>
            <h5 class="font-weight-bold mb-0">Portal Dashboard</h5>
        </div>
        <div id="userBadge" class="d-none">
            <div class="dropdown">
                <button class="btn btn-light border rounded-pill px-3 py-1 font-weight-bold small shadow-sm" data-toggle="dropdown">
                    <i class="fas fa-circle text-success mr-1 small"></i> <span id="lblPhone">User</span>
                </button>
                <div class="dropdown-menu dropdown-menu-right rounded-lg shadow border-0 mt-2">
                    <a class="dropdown-item text-danger font-weight-bold" href="#" onclick="clearIdentity()">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row mb-4">
        <div class="col-4">
            <div class="main-card p-3 text-center">
                <small class="text-muted font-weight-bold uppercase">Live</small>
                <div class="h4 font-weight-bold text-primary mb-0" id="statLive">0</div>
            </div>
        </div>
        <div class="col-4">
            <div class="main-card p-3 text-center">
                <small class="text-muted font-weight-bold uppercase">Matched</small>
                <div class="h4 font-weight-bold text-success mb-0" id="statMatch">0</div>
            </div>
        </div>
        <div class="col-4">
            <div class="main-card p-3 text-center">
                <small class="text-muted font-weight-bold uppercase">Waitlist</small>
                <div class="h4 font-weight-bold text-warning mb-0" id="statWait">0</div>
            </div>
        </div>
    </div>

    <div class="main-card p-4 mb-4">
        <div class="row">
            <div class="col-md-4 mb-3">
                <input type="text" id="inpSearch" class="filter-pill" placeholder="Search Designation (e.g. Typist)" oninput="debouncedRender()">
            </div>
            <div class="col-md-3 mb-3">
                <select id="selFrom" class="filter-pill" onchange="renderData()">
                    <option value="all">From Any District</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select id="selTo" class="filter-pill" onchange="renderData()">
                    <option value="all">To Any District</option>
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <button class="btn btn-outline-danger btn-block rounded-pill font-weight-bold" onclick="resetFilters()">
                    <i class="fas fa-sync"></i>
                </button>
            </div>
        </div>
        <div class="custom-control custom-switch mt-2">
            <input type="checkbox" class="custom-control-input" id="switchMyMatches" onchange="toggleMyMatches()">
            <label class="custom-control-label font-weight-bold text-muted" for="switchMyMatches">Only show potential matches for me</label>
        </div>
    </div>

    <div id="loadingGroup" class="row">
        <div class="col-md-6 mb-3"><div class="main-card p-5 skeleton"></div></div>
        <div class="col-md-6 mb-3"><div class="main-card p-5 skeleton"></div></div>
    </div>

    <div id="dataGrid" class="row"></div>

    <div id="emptyState">
        <i class="fas fa-search fa-3x text-light mb-3"></i>
        <h5 class="text-muted font-weight-bold">No results found</h5>
        <p class="text-muted small">Try adjusting your filters or search keywords.</p>
    </div>
</div>

<div class="modal fade" id="modalContact" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-xl">
            <div class="modal-body p-5 text-center">
                <div class="mb-4">
                    <h6 class="text-primary font-weight-bold">TRANSFER PARTNER</h6>
                    <h2 id="viewName" class="font-weight-bold">---</h2>
                </div>
                <div class="bg-light p-4 rounded-lg border mb-4">
                    <span class="text-muted small d-block mb-1">PHONE NUMBER</span>
                    <h2 class="font-weight-bold" id="viewPhone">---</h2>
                </div>
                <div class="row gutter-sm">
                    <div class="col-6"><a id="linkCall" class="btn btn-primary btn-block py-3 font-weight-bold"><i class="fas fa-phone mr-2"></i>Call</a></div>
                    <div class="col-6"><a id="linkWA" target="_blank" class="btn btn-success btn-block py-3 font-weight-bold"><i class="fab fa-whatsapp mr-2"></i>Chat</a></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwEDsxnfueDEQROnUckRjcPX3E5ph47xe0WqHTA5uc_2bIRz-oJl__SmuDpLBTFBv9ZVw/exec";
    let MASTER_DATA = [], MY_PHONE = localStorage.getItem("userPhone");
    let debounceTimer;

    $(document).ready(() => {
        if(MY_PHONE) {
            $('#userBadge').removeClass('d-none');
            $('#lblPhone').text(MY_PHONE.substring(0,2) + '...' + MY_PHONE.substring(8));
        }
        init();
    });

    async function init() {
        try {
            const resp = await fetch(`${API}?action=getDashboardData`);
            MASTER_DATA = await resp.json();
            updateStats();
            populateFilters();
            renderData();
        } catch(e) { console.error("Sync Error", e); }
    }

    function updateStats() {
        $('#statLive').text(MASTER_DATA.length);
        $('#statMatch').text(MASTER_DATA.filter(x => x.MATCH_STATUS.includes("MATCH")).length);
        $('#statWait').text(MASTER_DATA.filter(x => x.MATCH_STATUS === "Pending").length);
    }

    function populateFilters() {
        const froms = [...new Set(MASTER_DATA.map(x => x['Working District']))].sort();
        const tos = [...new Set(MASTER_DATA.map(x => x['Willing District']))].sort();
        
        froms.forEach(d => $('#selFrom').append(`<option value="${d}">${d}</option>`));
        tos.forEach(d => $('#selTo').append(`<option value="${d}">${d}</option>`));
    }

    function debouncedRender() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(renderData, 300);
    }

    function renderData() {
        $('#loadingGroup').hide();
        const grid = $('#dataGrid').empty();
        const search = $('#inpSearch').val().toLowerCase();
        const from = $('#selFrom').val();
        const to = $('#selTo').val();
        const onlyMine = $('#switchMyMatches').is(':checked');

        const myProfile = MASTER_DATA.find(x => String(x.phone) === String(MY_PHONE));

        const filtered = MASTER_DATA.filter(item => {
            const matchesSearch = item['Your Designation'].toLowerCase().includes(search);
            const matchesFrom = from === 'all' || item['Working District'] === from;
            const matchesTo = to === 'all' || item['Willing District'] === to;
            
            if (onlyMine && myProfile) {
                const isMatch = (item['Working District'] === myProfile['Willing District'] && item['Willing District'] === myProfile['Working District']) ||
                                (item.MATCH_STATUS.includes("3-WAY") && (item['Working District'] === myProfile['Willing District'] || item['Willing District'] === myProfile['Working District'])) ||
                                (String(item.phone) === String(MY_PHONE));
                return matchesSearch && matchesFrom && matchesTo && isMatch;
            }
            return matchesSearch && matchesFrom && matchesTo;
        });

        if(filtered.length === 0) { $('#emptyState').show(); return; }
        $('#emptyState').hide();

        filtered.forEach(item => {
            const isMe = String(item.phone) === String(MY_PHONE);
            const hasMatch = item.MATCH_STATUS.includes("MATCH");
            
            let statusClass = "badge-pending";
            if(item.MATCH_STATUS.includes("3-WAY")) statusClass = "badge-3way";
            else if(hasMatch) statusClass = "badge-match";

            grid.append(`
                <div class="col-md-6 mb-4">
                    <div class="main-card p-4 h-100 ${isMe ? 'my-post-glow' : ''}">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="font-weight-bold text-primary mb-1">${item['Your Designation']}</h6>
                                <span class="status-badge ${statusClass}">${item.MATCH_STATUS}</span>
                            </div>
                            <div class="text-right">
                                <span class="small font-weight-bold text-muted d-block">DEMAND</span>
                                <span class="badge ${item.DEMAND_STATUS.includes('HIGH') ? 'badge-danger' : 'badge-light'} border">${item.DEMAND_STATUS}</span>
                            </div>
                        </div>
                        
                        <div class="row no-gutters bg-light rounded p-3 mb-3">
                            <div class="col-5">
                                <small class="text-muted d-block">CURRENT</small>
                                <span class="font-weight-bold small">${item['Working District']}</span>
                            </div>
                            <div class="col-2 text-center text-muted">
                                <i class="fas fa-arrow-right mt-2"></i>
                            </div>
                            <div class="col-5">
                                <small class="text-muted d-block">WILLING</small>
                                <span class="font-weight-bold small">${item['Willing District']}</span>
                            </div>
                        </div>

                        <div class="d-flex align-items-center justify-content-between">
                            <small class="text-muted font-weight-bold">Joined: ${item['Date of Joining (DD-MM-YYYY)'] || 'N/A'}</small>
                            <button class="btn btn-unlock ${!hasMatch ? 'opacity-50' : ''}" 
                                    onclick="viewContact(${item.id}, ${hasMatch})">
                                ${hasMatch ? '<i class="fas fa-lock-open mr-2"></i>Unlock' : '<i class="fas fa-lock mr-2"></i>Locked'}
                            </button>
                        </div>
                    </div>
                </div>
            `);
        });
    }

    async function viewContact(id, hasMatch) {
        if(!hasMatch) return;
        if(!MY_PHONE) { alert("Please login first to view contacts."); return; }
        
        // Show local loader
        $('#dataGrid').css('opacity', '0.5');
        
        try {
            const r = await fetch(API, {
                method: "POST",
                body: JSON.stringify({ rowId: id, userPhone: MY_PHONE })
            });
            const res = await r.json();
            
            if(res.error) alert(res.error);
            else {
                $('#viewName').text(res.name);
                $('#viewPhone').text(res.contact);
                $('#linkCall').attr("href", "tel:" + res.contact);
                $('#linkWA').attr("href", "https://wa.me/91" + res.contact);
                $('#modalContact').modal('show');
            }
        } finally {
            $('#dataGrid').css('opacity', '1');
        }
    }

    function resetFilters() {
        $('#inpSearch').val('');
        $('#selFrom').val('all');
        $('#selTo').val('all');
        $('#switchMyMatches').prop('checked', false);
        renderData();
    }

    function toggleMyMatches() {
        if(!MY_PHONE) {
            alert("Please provide your phone number in the registration page first.");
            $('#switchMyMatches').prop('checked', false);
            return;
        }
        renderData();
    }

    function clearIdentity() {
        localStorage.removeItem("userPhone");
        location.reload();
    }
</script>
</body>
</html>
