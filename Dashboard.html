<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Mutual Transfer Live Portal</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
:root{
--primary:#2563eb;--primary-dark:#1e40af;--bg:#f8fafc;--border:#e2e8f0
}
body{background:var(--bg);font-family:Inter;color:#1e293b}
.dashboard-header{background:#fff;padding:15px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1050}
.stat-card{background:#fff;border-radius:16px;padding:20px;text-align:center;border:1px solid var(--border)}
.stat-card h2{font-size:.7rem;color:#64748b;font-weight:800}
.stat-card p{font-size:1.6rem;color:var(--primary);font-weight:800}
.filter-section{background:#fff;border-radius:20px;padding:25px;border:1px solid var(--border)}
.search-input{border-radius:10px;border:1px solid #cbd5e1;height:45px}
.table-container{background:#fff;border-radius:16px;border:1px solid var(--border)}
.thead-dark th{background:#0f172a;border:none;color:#fff}
.badge-match{background:#dcfce7;color:#166534;font-weight:700}
.badge-3way{background:#e0f2fe;color:#0369a1;font-weight:700}
.badge-high{background:#fee2e2;color:#dc2626;font-weight:700}
.btn-view-action{background:var(--primary);color:#fff;border-radius:12px;font-weight:700}
.btn-view-action:hover{background:var(--primary-dark)}
.mobile-card{background:#fff;border-radius:18px;padding:20px;margin-bottom:15px;border:1px solid var(--border)}
#globalLoader{position:fixed;inset:0;background:rgba(255,255,255,.85);z-index:9999;display:flex;align-items:center;justify-content:center}
@media(max-width:768px){.desktop-only{display:none}.mobile-card{display:block}}
</style>
</head>

<body>

<div id="globalLoader">
  <div class="text-center">
    <div class="spinner-border text-primary"></div>
    <p class="mt-2 font-weight-bold text-muted">Loading data…</p>
  </div>
</div>

<div class="dashboard-header">
<div class="container d-flex justify-content-between">
<h5 class="font-weight-bold"><i class="fas fa-sync-alt text-primary mr-2"></i>Mutual Transfer Live</h5>
<button id="idBadge" class="btn btn-sm btn-light d-none" onclick="clearIdentity()">
<i class="fas fa-user-check text-success mr-1"></i><span id="identityLabel"></span>
</button>
</div>
</div>

<div class="container mt-4">

<div class="row mb-4">
<div class="col-4"><div class="stat-card"><h2>Requests</h2><p id="totalRequests">0</p></div></div>
<div class="col-4"><div class="stat-card"><h2>Matches</h2><p id="totalMatches">0</p></div></div>
<div class="col-4"><div class="stat-card"><h2>Success</h2><p id="successRate">0%</p></div></div>
</div>

<div class="filter-section mb-4">
<div class="row">
<div class="col-md-3 mb-2">
<input id="globalSearch" class="form-control search-input" placeholder="Search designation…" onkeyup="filterTable()">
</div>
<div class="col-md-3 mb-2">
<select id="filterFrom" class="form-control search-input" onchange="filterTable()">
<option value="all">All From</option>
</select>
</div>
<div class="col-md-3 mb-2">
<select id="filterTo" class="form-control search-input" onchange="filterTable()">
<option value="all">All To</option>
</select>
</div>
<div class="col-md-3 mb-2">
<select id="filterDemand" class="form-control search-input" onchange="filterTable()">
<option value="all">All Demand</option>
<option value="HIGH">High Only</option>
</select>
</div>
</div>
</div>

<div class="table-container desktop-only">
<table class="table table-hover m-0">
<thead class="thead-dark">
<tr><th>Designation</th><th>From</th><th>To</th><th>Demand</th><th>Status</th><th>Action</th></tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<div id="mobileCardContainer" class="d-md-none"></div>

</div>

<!-- VERIFY MODAL -->
<div class="modal fade" id="verifyModal">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content p-4 text-center">
<h5>Verify Mobile</h5>
<input id="userPhoneInput" class="form-control text-center my-3" placeholder="10-digit mobile">
<button class="btn btn-primary btn-block" onclick="handleVerify()">Verify</button>
</div>
</div>
</div>

<!-- CONTACT MODAL -->
<div class="modal fade" id="contactModal">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content p-4 text-center">
<h5 id="resName">---</h5>
<h3 class="text-primary" id="resPhone">---</h3>
<a id="callBtn" class="btn btn-primary btn-block mt-2">Call</a>
<a id="waBtn" class="btn btn-success btn-block mt-2">WhatsApp</a>
</div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwEDsxnfueDEQROnUckRjcPX3E5ph47xe0WqHTA5uc_2bIRz-oJl__SmuDpLBTFBv9ZVw/exec";
let allData=[],pendingRowId=null,lastUnlock=0,filterTimer=null;

$(document).ready(()=>{
checkStoredIdentity();
fetchData();
setInterval(fetchData,60000);
});

function fetchData(){
$("#globalLoader").show();
fetch(`${SCRIPT_URL}?action=getDashboardData`,{cache:"no-store"})
.then(r=>r.json())
.then(d=>{
allData=d||[];
updateMetrics(d);
populateDropdowns(d);
filterTable();
$("#globalLoader").hide();
})
.catch(()=>$("#globalLoader").html("<h5 class='text-danger'>Connection failed</h5>"));
}

function populateDropdowns(d){
const f=new Set(),t=new Set();
d.forEach(r=>{if(r['Working District'])f.add(r['Working District']);if(r['Willing District'])t.add(r['Willing District'])});
$('#filterFrom').html('<option value="all">All From</option>'+[...f].sort().map(x=>`<option>${x}</option>`));
$('#filterTo').html('<option value="all">All To</option>'+[...t].sort().map(x=>`<option>${x}</option>`));
}

function checkStoredIdentity(){
const p=localStorage.getItem("userPhone");
if(p){$('#identityLabel').text("***"+p.slice(-4));$('#idBadge').removeClass("d-none")}
}

function clearIdentity(){
localStorage.removeItem("userPhone");location.reload();
}

function updateMetrics(d){
$('#totalRequests').text(d.length);
const m=d.filter(x=>x.MATCH_STATUS?.includes("MATCH")).length;
$('#totalMatches').text(m);
$('#successRate').text(d.length?Math.round(m/d.length*100)+"%":"0%");
}

function filterTable(){
clearTimeout(filterTimer);
filterTimer=setTimeout(renderTable,200);
}

function renderTable(){
const s=$('#globalSearch').val().toLowerCase(),
f=$('#filterFrom').val(),
t=$('#filterTo').val(),
d=$('#filterDemand').val();
const list=allData.filter(r=>
r['Your Designation'].toLowerCase().includes(s)&&
(f==='all'||r['Working District']===f)&&
(t==='all'||r['Willing District']===t)&&
(d==='all'||r.DEMAND_STATUS?.includes("HIGH"))
);
$('#tableBody').empty();$('#mobileCardContainer').empty();
list.forEach(r=>{
const match=r.MATCH_STATUS?.includes("MATCH");
const badge=match?`<span class="${r.MATCH_STATUS.includes('3-WAY')?'badge-3way':'badge-match'}">${r.MATCH_STATUS}</span>`:'<span class="badge badge-light">Pending</span>';
const db=r.DEMAND_STATUS?.includes("HIGH")?'<span class="badge badge-high">High</span>':r.DEMAND_STATUS||'Normal';

$('#tableBody').append(`
<tr>
<td><b>${r['Your Designation']}</b></td>
<td>${r['Working District']}</td>
<td>${r['Willing District']}</td>
<td>${db}</td>
<td>${badge}</td>
<td><button class="btn btn-sm ${match?'btn-view-action':'btn-light'}" onclick="initiateView(${r.id},${match})">${match?'View':'Locked'}</button></td>
</tr>`);

$('#mobileCardContainer').append(`
<div class="mobile-card">
<b>${r['Your Designation']}</b>
<div>${r['Working District']} → ${r['Willing District']}</div>
${badge}<br>${db}
<button class="btn btn-sm mt-2 ${match?'btn-view-action':'btn-light'}" onclick="initiateView(${r.id},${match})">${match?'Unlock':'Wait'}</button>
</div>`);
});
}

function initiateView(id,ok){
if(!ok)return;
if(Date.now()-lastUnlock<3000)return alert("Please wait");
lastUnlock=Date.now();
pendingRowId=id;
const p=localStorage.getItem("userPhone");
p?processRequest(id,p):$('#verifyModal').modal('show');
}

function handleVerify(){
const p=$('#userPhoneInput').val().trim();
if(!/^[6-9]\d{9}$/.test(p))return alert("Invalid mobile");
localStorage.setItem("userPhone",p);
$('#verifyModal').modal('hide');
checkStoredIdentity();
processRequest(pendingRowId,p);
}

function processRequest(id,p){
$("#globalLoader").show();
fetch(SCRIPT_URL,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({rowId:id,userPhone:p})})
.then(r=>r.json())
.then(r=>{
$("#globalLoader").hide();
if(r.error){alert(r.error);clearIdentity();return}
$('#resName').text(r.name);
$('#resPhone').text(r.contact);
$('#callBtn').attr("href","tel:"+r.contact);
$('#waBtn').attr("href","https://wa.me/91"+r.contact);
$('#contactModal').modal('show');
})
.catch(()=>alert("Server error"));
}
</script>
</body>
</html>
