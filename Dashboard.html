<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Mutual Transfer Live Portal</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
body{background:#f8fafc;font-family:Inter}
.stat-card{background:#fff;border-radius:16px;padding:20px;text-align:center;border:1px solid #e2e8f0}
.badge-match{background:#dcfce7;color:#166534;font-weight:700}
.badge-3way{background:#e0f2fe;color:#0369a1;font-weight:700}
.badge-high{background:#fee2e2;color:#dc2626;font-weight:700}
.btn-view-action{background:#2563eb;color:#fff;border-radius:12px;font-weight:700}
.mobile-card{background:#fff;border-radius:16px;padding:16px;margin-bottom:12px;border:1px solid #e2e8f0}
</style>
</head>

<body>

<div id="globalLoader" class="position-fixed w-100 h-100 d-flex align-items-center justify-content-center bg-white" style="z-index:9999">
  <div class="text-center">
    <div class="spinner-border text-primary"></div>
    <p class="mt-2 font-weight-bold text-muted">Loading data...</p>
  </div>
</div>

<div class="container mt-4">

<div class="row mb-3">
  <div class="col"><div class="stat-card"><small>Requests</small><h3 id="totalRequests">0</h3></div></div>
  <div class="col"><div class="stat-card"><small>Matches</small><h3 id="totalMatches">0</h3></div></div>
  <div class="col"><div class="stat-card"><small>Success</small><h3 id="successRate">0%</h3></div></div>
</div>

<input id="globalSearch" class="form-control mb-3" placeholder="Search designation..." onkeyup="filterTable()">

<div id="tableWrapper"></div>

</div>

<!-- VERIFY MODAL -->
<div class="modal fade" id="verifyModal">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content p-4 text-center">
<h5>Verify Mobile</h5>
<input id="userPhoneInput" class="form-control text-center my-3" placeholder="10 digit mobile">
<button class="btn btn-primary btn-block" onclick="handleVerify()">Verify</button>
</div>
</div>
</div>

<!-- CONTACT MODAL -->
<div class="modal fade" id="contactModal">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content p-4 text-center">
<h5 id="resName">---</h5>
<h3 class="text-primary" id="resPhone">---</h3>
<a id="callBtn" class="btn btn-primary btn-block mt-2">Call</a>
<a id="waBtn" class="btn btn-success btn-block mt-2">WhatsApp</a>
</div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwEDsxnfueDEQROnUckRjcPX3E5ph47xe0WqHTA5uc_2bIRz-oJl__SmuDpLBTFBv9ZVw/exec";

let allData=[], pendingRowId=null;

$(document).ready(loadData);

function loadData(){
fetch(SCRIPT_URL + "?action=getDashboardData")
.then(r=>r.json())
.then(d=>{
allData=d;
updateStats(d);
render(d);
$("#globalLoader").hide();
})
.catch(()=>{
$("#globalLoader").html("<h5 class='text-danger'>Failed to load data</h5>");
});
}

function updateStats(d){
$("#totalRequests").text(d.length);
const m=d.filter(x=>x.MATCH_STATUS.includes("MATCH")).length;
$("#totalMatches").text(m);
$("#successRate").text(d.length?Math.round(m/d.length*100)+"%":"0%");
}

function render(data){
const q=$("#globalSearch").val()?.toLowerCase()||"";
const out=data.filter(r=>r.Designation.toLowerCase().includes(q));

let html="<table class='table table-bordered'><tr><th>Designation</th><th>From</th><th>To</th><th>Status</th><th></th></tr>";
out.forEach(r=>{
const matched=r.MATCH_STATUS.includes("MATCH");
html+=`<tr>
<td>${r.Designation}</td>
<td>${r.Working}</td>
<td>${r.Willing}</td>
<td>${matched?'<span class="badge badge-match">'+r.MATCH_STATUS+'</span>':'Pending'}</td>
<td><button class="btn btn-sm ${matched?'btn-view-action':'btn-light'}" onclick="view(${r.id},${matched})">${matched?'View':'Locked'}</button></td>
</tr>`;
});
html+="</table>";
$("#tableWrapper").html(html);
}

function filterTable(){render(allData)}

function view(id,ok){
if(!ok) return;
pendingRowId=id;
const phone=localStorage.getItem("userPhone");
phone?fetchContact(id,phone):$("#verifyModal").modal("show");
}

function handleVerify(){
const phone=$("#userPhoneInput").val().trim();
if(!/^[6-9]\d{9}$/.test(phone)) return alert("Invalid mobile");
localStorage.setItem("userPhone",phone);
$("#verifyModal").modal("hide");
fetchContact(pendingRowId,phone);
}

function fetchContact(id,phone){
$("#globalLoader").show();
fetch(SCRIPT_URL,{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({rowId:id,userPhone:phone})
})
.then(r=>r.json())
.then(res=>{
$("#globalLoader").hide();
if(res.error){
alert(res.error);
localStorage.removeItem("userPhone");
location.reload();
}else{
$("#resName").text(res.name);
$("#resPhone").text(res.contact);
$("#callBtn").attr("href","tel:"+res.contact);
$("#waBtn").attr("href","https://wa.me/91"+res.contact);
$("#contactModal").modal("show");
}
});
}
</script>
</body>
</html>
