<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Mutual Hub | Professional Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb;
            --primary-soft: #dbeafe;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --success: #10b981;
        }

        body { 
            background: var(--bg); 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        /* --- Modern Centered Loader --- */
        #globalLoader {
            position: fixed; inset: 0; 
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            z-index: 9999; display: none; align-items: center; justify-content: center;
        }
        .loader-content {
            background: white; padding: 30px 50px; border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            text-align: center; border: 1px solid var(--border);
        }

        /* --- Login/Overlay --- */
        #loginOverlay {
            position: fixed; inset: 0; background: var(--bg);
            z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .login-card {
            background: #fff; padding: 40px; border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.08); width: 100%; max-width: 420px;
            border: 1px solid var(--border);
        }

        #mainDashboard { display: none; }

        /* --- Header & Stats --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border); padding: 12px 0; position: sticky; top: 0; z-index: 1060;
        }
        .stat-card {
            background: var(--surface); border-radius: 24px; padding: 24px;
            border: 1px solid var(--border); transition: all 0.3s ease;
        }
        .stat-value { font-size: 2rem; font-weight: 800; letter-spacing: -0.02em; }

        /* --- Filters --- */
        .filter-section {
            background: white; border-radius: 28px; border: 1px solid var(--border);
            padding: 24px; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        }
        .filter-label {
            font-size: 0.75rem; font-weight: 800; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; display: block;
        }
        .filter-control { 
            height: 52px; border-radius: 14px; border: 1.5px solid var(--border); 
            font-weight: 600; color: var(--text-main); transition: all 0.2s;
        }
        .filter-control:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-soft); }

        /* --- Table --- */
        .table-wrapper {
            background: white; border-radius: 28px; border: 1px solid var(--border);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.04); overflow: hidden;
        }
        .table thead th {
            background: #f8fafc; text-transform: uppercase; font-size: 0.7rem;
            letter-spacing: 0.05em; padding: 20px; color: var(--text-muted); border-bottom: 1px solid var(--border);
        }
        .row-identity { background: #eff6ff !important; border-left: 4px solid var(--primary); }

        .btn-unlock { 
            background: var(--primary); color: white !important; border-radius: 12px; 
            padding: 10px 20px; font-weight: 700; border: none; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .error-msg { color: #ef4444; font-weight: 700; font-size: 0.85rem; display: none; margin-top: 10px; }

        @media (max-width: 768px) { .desktop-only { display: none; } }
    </style>
</head>
<body>

<div id="globalLoader">
    <div class="loader-content">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <h6 class="mt-4 font-weight-bold text-dark">Processing Data...</h6>
        <p class="text-muted small mb-0">Please wait a moment</p>
    </div>
</div>

<div id="loginOverlay">
    <div class="login-card text-center">
        <div class="bg-primary text-white d-inline-block p-3 rounded-circle mb-4 shadow-lg">
            <i class="fas fa-fingerprint fa-2xl"></i>
        </div>
        <h3 class="font-weight-bold">Member Portal</h3>
        <p class="text-muted small mb-4">Secure access for registered employees.</p>
        
        <input id="loginPhone" type="tel" maxlength="10" class="form-control text-center font-weight-bold" 
               style="height:64px; font-size:1.8rem; border-radius:18px; border: 2px solid var(--border);" placeholder="0000000000">
        
        <div id="loginError" class="error-msg">
            <i class="fas fa-circle-xmark mr-1"></i> Number not found!
        </div>

        <button class="btn btn-primary btn-block py-3 mt-4 font-weight-bold rounded-18 shadow-lg" onclick="handleLogin()">
            Verify Identity
        </button>

        <div id="regBox" class="mt-4 pt-3 border-top" style="display:none;">
            <p class="text-muted small mb-3">Don't have an account?</p>
            <a href="YOUR_REG_LINK" class="btn btn-outline-success btn-block py-2 font-weight-bold rounded-15">
                Register & Join Now
            </a>
        </div>
    </div>
</div>

<div id="mainDashboard">
    <header class="glass-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="bg-primary text-white p-2 rounded-lg mr-2 shadow-sm"><i class="fas fa-bolt"></i></div>
                <h5 class="font-weight-bold mb-0">Mutual Hub</h5>
            </div>
            <div class="bg-white border px-3 py-2 rounded-xl d-flex align-items-center shadow-sm">
                <span class="badge badge-success badge-pill mr-2" style="width:8px; height:8px; padding:0"> </span>
                <small class="font-weight-bold text-muted" id="lblUserPhone">---</small>
                <div class="border-left ml-3 pl-3">
                    <i class="fas fa-sign-out-alt text-danger cursor-pointer" onclick="clearIdentity()"></i>
                </div>
            </div>
        </div>
    </header>

    <div class="container mt-4 pb-5">
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="stat-card">
                    <span class="filter-label">Total Listings</span>
                    <span class="stat-value text-dark" id="statTotal">0</span>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stat-card">
                    <span class="filter-label">Verified Matches</span>
                    <span class="stat-value text-primary" id="statMatched">0</span>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="stat-card">
                    <span class="filter-label">System Accuracy</span>
                    <span class="stat-value text-success" id="statRate">0%</span>
                </div>
            </div>
        </div>

        <div class="filter-section shadow-sm">
            <div class="row">
                <div class="col-lg-4 col-md-12 mb-3">
                    <label class="filter-label"><i class="fas fa-search mr-1"></i> Designation Search</label>
                    <input id="inpSearch" class="form-control filter-control" placeholder="e.g. Teacher, Clerk..." oninput="renderTable()">
                </div>
                <div class="col-lg-2 col-6 mb-3">
                    <label class="filter-label"><i class="fas fa-map-pin mr-1"></i> From District</label>
                    <select id="selFrom" class="form-control filter-control" onchange="renderTable()"><option value="all">Any District</option></select>
                </div>
                <div class="col-lg-2 col-6 mb-3">
                    <label class="filter-label"><i class="fas fa-location-arrow mr-1"></i> To District</label>
                    <select id="selTo" class="form-control filter-control" onchange="renderTable()"><option value="all">Any District</option></select>
                </div>
                <div class="col-lg-3 col-10 mb-3 d-flex align-items-end">
                    <button id="btnMatches" class="btn btn-outline-primary font-weight-bold rounded-14 w-100" style="height:52px;" onclick="toggleMatches()">
                        View My Matches
                    </button>
                </div>
                <div class="col-lg-1 col-2 mb-3 d-flex align-items-end">
                    <button class="btn btn-light border rounded-14 w-100" style="height:52px;" onclick="resetUI()"><i class="fas fa-undo"></i></button>
                </div>
            </div>
        </div>

        <div class="table-wrapper">
            <div class="table-responsive">
                <table class="table m-0">
                    <thead>
                        <tr>
                            <th>Employee Details</th>
                            <th>Current Station</th>
                            <th>Willing District</th>
                            <th class="desktop-only text-center">Status</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="mainTbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script>
    const API = "https://script.google.com/macros/s/AKfycbwEDsxnfueDEQROnUckRjcPX3E5ph47xe0WqHTA5uc_2bIRz-oJl__SmuDpLBTFBv9ZVw/exec";
    let MASTER_DATA = [], FILTER_MATCHES = false;
    let MY_PHONE = localStorage.getItem("userPhone");

    $(document).ready(() => {
        loadData(false); // Silent pre-load
        if(MY_PHONE) checkAndEnter(MY_PHONE);
    });

    function loadData(shouldRender = true) {
        $("#globalLoader").css("display", "flex");
        fetch(`${API}?action=getDashboardData`)
        .then(r => r.json())
        .then(data => {
            MASTER_DATA = data || [];
            if(shouldRender) {
                updateStatistics(MASTER_DATA);
                buildFilters();
                renderTable();
            }
            $("#globalLoader").fadeOut();
        });
    }

    function handleLogin() {
        const val = $('#loginPhone').val();
        $('#loginError').hide(); $('#regBox').hide();
        if(!/^\d{10}$/.test(val)) return alert("Enter valid 10-digit number.");
        checkAndEnter(val);
    }

    function checkAndEnter(phone) {
        const userExists = MASTER_DATA.some(x => String(x.phone) === String(phone));
        if(userExists) {
            localStorage.setItem("userPhone", phone);
            MY_PHONE = phone;
            $('#loginOverlay').fadeOut();
            $('#mainDashboard').fadeIn();
            $('#lblUserPhone').text(MY_PHONE.slice(0,2) + '****' + MY_PHONE.slice(8));
            updateStatistics(MASTER_DATA);
            buildFilters();
            renderTable();
        } else {
            $('#loginError').fadeIn();
            $('#regBox').fadeIn();
        }
    }

    function updateStatistics(data) {
        const total = data.length;
        const matched = data.filter(r => r.MATCH_STATUS.includes("MATCH")).length;
        $('#statTotal').text(total);
        $('#statMatched').text(matched);
        $('#statRate').text(total > 0 ? Math.round((matched / total) * 100) + '%' : '0%');
    }

    function buildFilters() {
        const fromSet = [...new Set(MASTER_DATA.map(x => x['Working District']))].sort();
        const toSet = [...new Set(MASTER_DATA.map(x => x['Willing District']))].sort();
        $('#selFrom').html('<option value="all">Any District</option>');
        $('#selTo').html('<option value="all">Any District</option>');
        fromSet.forEach(d => $('#selFrom').append(`<option value="${d}">${d}</option>`));
        toSet.forEach(d => $('#selTo').append(`<option value="${d}">${d}</option>`));
    }

    function renderTable() {
        const query = $('#inpSearch').val().toLowerCase();
        const from = $('#selFrom').val();
        const to = $('#selTo').val();
        const me = MASTER_DATA.find(x => String(x.phone) === String(MY_PHONE));

        const filtered = MASTER_DATA.filter(r => {
            const matchesBasic = r['Your Designation'].toLowerCase().includes(query) &&
                                (from === 'all' || r['Working District'] === from) &&
                                (to === 'all' || r['Willing District'] === to);
            if (FILTER_MATCHES && me) {
                const isMatch = (r['Working District'] === me['Willing District'] && r['Willing District'] === me['Working District']) ||
                                (r.MATCH_STATUS.includes("3-WAY") && (r['Working District'] === me['Willing District'] || r['Willing District'] === me['Working District'])) ||
                                (String(r.phone) === String(MY_PHONE));
                return matchesBasic && isMatch;
            }
            return matchesBasic;
        });

        const tbody = $('#mainTbody').empty();
        filtered.forEach(row => {
            const isMe = String(row.phone) === String(MY_PHONE);
            const hasMatch = row.MATCH_STATUS.includes("MATCH");
            
            tbody.append(`
                <tr class="${isMe ? 'row-identity' : ''}">
                    <td><div class="font-weight-bold text-dark">${row['Your Designation']}</div>${isMe ? '<span class="badge badge-primary">You</span>':''}</td>
                    <td>${row['Working District']}</td>
                    <td>${row['Willing District']}</td>
                    <td class="desktop-only text-center"><span class="badge badge-light border py-2 px-3 rounded-pill">${row.MATCH_STATUS || 'Pending'}</span></td>
                    <td class="text-center">
                        <button class="btn btn-unlock" onclick="unlockRow(${row.id}, ${hasMatch})">
                            <i class="fas ${hasMatch ? 'fa-lock-open' : 'fa-lock'}"></i>
                        </button>
                    </td>
                </tr>
            `);
        });
    }

    function toggleMatches() {
        FILTER_MATCHES = !FILTER_MATCHES;
        $('#btnMatches').toggleClass('btn-primary btn-outline-primary text-white');
        renderTable();
    }

    function clearIdentity() {
        localStorage.removeItem("userPhone");
        location.reload();
    }

    function resetUI() {
        $('#inpSearch').val(''); $('#selFrom').val('all'); $('#selTo').val('all');
        FILTER_MATCHES = false; renderTable();
    }
</script>
</body>
</html>
