<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mutual Transfer | Secure Registration</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Plus Jakarta Sans',sans-serif;
  background:radial-gradient(circle at top right,#f8fafc,#f1f5f9);
}
.input{border:1.5px solid #e2e8f0}
.input:focus{border-color:#2563eb;box-shadow:0 0 0 4px rgba(37,99,235,.15)}
.segment.active{background:#1e293b;color:#fff}
.mandatory::after{content:" *";color:#ef4444}
</style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

<!-- Loader -->
<div id="loader" class="hidden fixed inset-0 bg-black/20 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl text-center shadow-xl">
    <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
    <p class="mt-3 font-semibold">Processing securelyâ€¦</p>
  </div>
</div>

<div class="bg-white/90 backdrop-blur-xl w-full max-w-3xl rounded-3xl shadow-2xl p-8">

<h1 class="text-3xl font-extrabold mb-1">Registration</h1>
<p class="text-slate-500 mb-8">Mutual Transfer Network Portal</p>

<form id="regForm" class="space-y-6">

<div class="grid md:grid-cols-2 gap-6">
  <div>
    <label class="mandatory text-xs font-bold text-slate-500">FULL NAME</label>
    <input id="name" required class="input w-full rounded-xl px-4 py-3 mt-1">
  </div>
  <div>
    <label class="mandatory text-xs font-bold text-slate-500">DATE OF JOINING</label>
    <input id="doj" type="date" required class="input w-full rounded-xl px-4 py-3 mt-1">
  </div>
</div>

<div class="grid md:grid-cols-2 gap-6">
  <div>
    <label class="mandatory text-xs font-bold text-slate-500">DESIGNATION</label>
    <select id="designation" required class="input w-full rounded-xl px-4 py-3 mt-1">
      <option value="">Select</option>
      <option>Junior Assistant</option>
      <option>Typist</option>
      <option>Steno Typist</option>
      <option>Others</option>
    </select>
  </div>
  <div>
    <label class="mandatory text-xs font-bold text-slate-500">WHATSAPP NUMBER</label>
    <input id="phone" maxlength="10" pattern="[6-9][0-9]{9}" required
           class="input w-full rounded-xl px-4 py-3 mt-1"
           placeholder="10-digit mobile">
  </div>
</div>

<div class="grid md:grid-cols-2 gap-6">
  <div>
    <label class="mandatory text-xs font-bold text-slate-500">PROBATION DECLARED?</label>
    <div class="flex gap-2 mt-1">
      <button type="button" class="segment flex-1 border rounded-xl py-2"
        onclick="toggle('probation','Yes',this)">Yes</button>
      <button type="button" class="segment active flex-1 border rounded-xl py-2"
        onclick="toggle('probation','No',this)">No</button>
    </div>
    <input type="hidden" id="probation" value="No">
  </div>

  <div>
    <label class="mandatory text-xs font-bold text-slate-500">COA COMPLETED?</label>
    <div class="flex gap-2 mt-1">
      <button type="button" class="segment flex-1 border rounded-xl py-2"
        onclick="toggle('coa','Yes',this)">Yes</button>
      <button type="button" class="segment active flex-1 border rounded-xl py-2"
        onclick="toggle('coa','No',this)">No</button>
    </div>
    <input type="hidden" id="coa" value="No">
  </div>
</div>

<div class="grid md:grid-cols-2 gap-6">
  <div>
    <label class="mandatory text-xs font-bold text-slate-500">WORKING DISTRICT</label>
    <select id="workingDistrict" required class="input w-full rounded-xl px-4 py-3 mt-1"></select>
  </div>
  <div>
    <label class="mandatory text-xs font-bold text-slate-500">WILLING DISTRICT</label>
    <select id="willingDistrict" required class="input w-full rounded-xl px-4 py-3 mt-1"></select>
  </div>
</div>

<div>
  <label class="mandatory text-xs font-bold text-slate-500">EMAIL</label>
  <div class="flex gap-3 mt-1">
    <input id="email" type="email" required class="input flex-1 rounded-xl px-4 py-3">
    <button type="button" id="otpBtn" onclick="sendOTP()"
      class="bg-blue-600 text-white px-6 rounded-xl font-bold">
      Get OTP
    </button>
  </div>
  <p id="otpTimer" class="text-xs text-slate-500 mt-2 hidden"></p>
</div>

<div id="otpBox" class="hidden">
  <label class="mandatory text-xs font-bold text-slate-500">ENTER OTP</label>
  <input id="otp" maxlength="4"
    class="input w-full text-center text-3xl tracking-widest rounded-xl px-4 py-4 mt-2">
  <button type="button" onclick="submitForm()"
    class="mt-4 w-full bg-slate-900 text-white py-4 rounded-xl font-bold">
    Submit Registration
  </button>
</div>

</form>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwEDsxnfueDEQROnUckRjcPX3E5ph47xe0WqHTA5uc_2bIRz-oJl__SmuDpLBTFBv9ZVw/exec";
let otpCooldown=0;

function toggle(field,val,btn){
  document.getElementById(field).value=val;
  btn.parentElement.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

window.onload=()=>{
fetch(`${SCRIPT_URL}?action=getDistricts`)
.then(r=>r.json())
.then(d=>{
const opt=d.map(x=>`<option>${x}</option>`).join('');
workingDistrict.innerHTML='<option value="">Select</option>'+opt;
willingDistrict.innerHTML='<option value="">Select</option>'+opt;
});
};

function sendOTP(){
if(otpCooldown>0)return;
if(!/^[6-9]\d{9}$/.test(phone.value))return alert("Invalid mobile");
if(!email.value.includes("@"))return alert("Invalid email");

loader.classList.remove("hidden");
fetch(`${SCRIPT_URL}?action=sendOTP&email=${encodeURIComponent(email.value)}`)
.then(r=>r.json())
.then(res=>{
loader.classList.add("hidden");
if(res.status!=="SENT")return alert(res.message);
otpBox.classList.remove("hidden");
otp.focus();
startCooldown();
});
}

function startCooldown(){
otpCooldown=60;
otpBtn.disabled=true;
const t=document.getElementById("otpTimer");
t.classList.remove("hidden");
const i=setInterval(()=>{
t.textContent=`Resend OTP in ${otpCooldown}s`;
otpCooldown--;
if(otpCooldown<0){clearInterval(i);otpBtn.disabled=false;t.classList.add("hidden")}
},1000);
}

function submitForm(){
if(workingDistrict.value===willingDistrict.value)
return alert("Working and Willing districts cannot be same");

loader.classList.remove("hidden");
fetch(SCRIPT_URL,{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
action:"register",
otp:otp.value,
userData:{
name:name.value,
doj:doj.value,
designation:designation.value,
phone:phone.value,
probation:probation.value,
coa:coa.value,
workingDistrict:workingDistrict.value,
willingDistrict:willingDistrict.value,
email:email.value
}
})
})
.then(r=>r.json())
.then(res=>{
loader.classList.add("hidden");
if(res.status==="SUCCESS"){
alert("Registration successful!");
location.reload();
}else{
alert(res.message||"Registration failed");
}
});
}
</script>
</body>
</html>
