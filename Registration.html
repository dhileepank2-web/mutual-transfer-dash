<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register | Mutual Transfer Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f0f2f5; font-family: 'Inter', sans-serif; }
        .reg-card { max-width: 600px; margin: 40px auto; border: none; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .card-header { background: #ffffff; border-bottom: 1px solid #eee; padding: 25px; border-radius: 16px 16px 0 0 !important; }
        .form-label { font-weight: 600; color: #444; font-size: 0.9rem; }
        .form-control, .form-select { padding: 12px; border-radius: 8px; border: 1px solid #ced4da; }
        .form-control:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13,110,253,0.15); }
        .btn-primary { padding: 12px; border-radius: 8px; font-weight: 600; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(13,110,253,0.3); }
        .otp-section { background: #f8f9fa; border-radius: 12px; padding: 20px; border: 1px dashed #dee2e6; }
        .hidden { display: none; }
        @media (max-width: 576px) { .reg-card { margin: 10px; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card reg-card">
        <div class="card-header text-center">
            <h4 class="mb-0 text-primary"><i class="fa-solid fa-user-plus me-2"></i>Registration Form</h4>
            <small class="text-muted">Enter your details for mutual transfer matching</small>
        </div>
        <div class="card-body p-4">
            <form id="regForm">
                <div class="mb-3">
                    <label class="form-label">Full Name (As per Service Register)</label>
                    <input type="text" id="name" class="form-control" placeholder="e.g. ARUN KUMAR S" required>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Designation</label>
                        <select id="designation" class="form-select" onchange="toggleOther(this.value)" required>
                            <option value="">Select...</option>
                            <option value="Typist">Typist</option>
                            <option value="Junior Assistant">Junior Assistant</option>
                            <option value="Steno Typist">Steno Typist</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Date of Joining</label>
                        <input type="date" id="doj" class="form-control" required>
                    </div>
                </div>

                <div id="otherDesignationDiv" class="mb-3 hidden">
                    <label class="form-label">Specify Designation</label>
                    <input type="text" id="otherDesignation" class="form-control" placeholder="Enter your role">
                </div>

                <hr class="my-4">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Working District</label>
                        <select id="workingDistrict" class="form-select" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Willing District</label>
                        <select id="willingDistrict" class="form-select" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Probation Declared?</label>
                        <select id="probation" class="form-select">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label">COA Completed?</label>
                        <select id="coa" class="form-select">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                </div>

                <hr class="my-4">

                <div class="mb-3">
                    <label class="form-label">WhatsApp Number</label>
                    <div class="input-group">
                        <span class="input-group-text">+91</span>
                        <input type="tel" id="phone" class="form-control" placeholder="10-digit number" pattern="[6789][0-9]{9}" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label">Official Email Address</label>
                    <input type="email" id="email" class="form-control" placeholder="email@example.com" required>
                </div>

                <div id="otpSection" class="otp-section hidden mb-4">
                    <label class="form-label text-primary">Enter 4-Digit OTP sent to Email</label>
                    <div class="d-flex gap-2">
                        <input type="text" id="otpInput" class="form-control text-center fw-bold fs-4" maxlength="4" placeholder="0000">
                        <button type="button" class="btn btn-success px-4" onclick="finalSubmit()">VERIFY</button>
                    </div>
                    <small class="text-muted mt-2 d-block">Check your Inbox or Spam folder.</small>
                </div>

                <button type="button" id="sendOtpBtn" class="btn btn-primary w-100 py-3" onclick="requestOTP()">
                    <i class="fa-solid fa-paper-plane me-2"></i>SEND VERIFICATION OTP
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    const GAS_URL = "YOUR_APPS_SCRIPT_WEB_APP_URL"; // Use the Web App Exec URL

    // 1. Auto-load Districts using your Sheet-based function
    window.onload = () => {
        google.script.run.withSuccessHandler(districts => {
            const options = districts.map(d => `<option value="${d}">${d}</option>`).join('');
            document.getElementById('workingDistrict').innerHTML = `<option value="">--Select--</option>` + options;
            document.getElementById('willingDistrict').innerHTML = `<option value="">--Select--</option>` + options;
        }).getDistrictList();
    };

    function toggleOther(val) {
        document.getElementById('otherDesignationDiv').classList.toggle('hidden', val !== 'Other');
    }

    function requestOTP() {
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        
        if(!email || !phone) { alert("Please fill Email and Phone first!"); return; }

        document.getElementById('sendOtpBtn').disabled = true;
        document.getElementById('sendOtpBtn').innerHTML = "Sending...";

        google.script.run.withSuccessHandler(res => {
            alert("OTP sent to your email address.");
            document.getElementById('otpSection').classList.remove('hidden');
            document.getElementById('sendOtpBtn').classList.add('hidden');
        }).requestEmailOTP(email);
    }

    function finalSubmit() {
        const otp = document.getElementById('otpInput').value;
        const formData = {
            name: document.getElementById('name').value,
            designation: document.getElementById('designation').value === 'Other' ? 
                         document.getElementById('otherDesignation').value : 
                         document.getElementById('designation').value,
            doj: document.getElementById('doj').value,
            workingDistrict: document.getElementById('workingDistrict').value,
            willingDistrict: document.getElementById('willingDistrict').value,
            probation: document.getElementById('probation').value,
            coa: document.getElementById('coa').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value
        };

        google.script.run
            .withSuccessHandler(() => {
                alert("Registration Successful!");
                window.location.href = "index.html";
            })
            .withFailureHandler(err => alert(err))
            .registerUser(formData, otp);
    }
</script>

</body>
</html>
