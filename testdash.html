<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Mutual Hub | Professional Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb;
            --primary-glow: rgba(37, 99, 235, 0.4);
            --bg: #f8fafc;
            --surface: rgba(255, 255, 255, 0.8);
            --border: rgba(226, 232, 240, 0.8);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --success: #10b981;
        }

        body {
            background: #f1f5f9;
            background-image: radial-gradient(at 0% 0%, rgba(37, 99, 235, 0.05) 0, transparent 50%), 
                              radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.05) 0, transparent 50%);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
        }

        /* --- Glassmorphism Overhaul --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1060;
        }

        .stat-container, .table-wrapper, .bg-white.p-4 {
            background: var(--surface) !important;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border) !important;
            border-radius: 24px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        /* --- Micro-interactions & Animations --- */
        .row-identity {
            background: rgba(37, 99, 235, 0.05) !important;
            box-shadow: inset 4px 0 0 var(--primary);
        }

        .match-glow {
            animation: matchPulse 2s infinite alternate;
        }

        @keyframes matchPulse {
            from { box-shadow: 0 0 0px rgba(16, 185, 129, 0); }
            to { box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); }
        }

        /* --- Skeleton Shimmer --- */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
            height: 20px;
            width: 100%;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* --- Transfer Corridor Visualization --- */
        #corridorContainer {
            background: rgba(248, 250, 252, 0.8);
            border-radius: 20px;
            padding: 25px;
            border: 1px dashed #cbd5e1;
        }

        .corridor-node {
            text-align: center;
            flex: 1;
        }

        .node-circle {
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            border: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 800;
        }

        /* --- Mobile FAB --- */
        .fab-edit {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white !important;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px var(--primary-glow);
            z-index: 1000;
            transition: transform 0.3s;
        }

        .fab-edit:hover { transform: scale(1.1); }

        /* Existing utility styles from previous version */
        .live-indicator { font-size: 0.65rem; font-weight: 800; color: #ef4444; background: #fee2e2; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; }
        .pulse-dot { height: 8px; width: 8px; background-color: #10b981; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0px rgba(16, 185, 129, 0); } }
        .btn-unlock { background: var(--primary); color: white !important; border-radius: 12px; padding: 8px 16px; border: none; font-weight: 700; }
        .stat-label { font-size: 0.72rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; }
        .stat-value { font-size: 1.6rem; font-weight: 800; }
    </style>
</head>
<body>

<a href="#" class="fab-edit d-md-none" onclick="redirectToRegistration()">
    <i class="fas fa-pen"></i>
</a>

<div id="globalLoader" style="position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" role="status"></div>
    <h6 class="mt-3 font-weight-bold">Syncing Encrypted Database...</h6>
</div>

<header class="glass-header py-3">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <div class="bg-primary text-white p-2 rounded-lg mr-3 shadow-sm">
                <i class="fas fa-shield-halved fa-lg"></i>
            </div>
            <h5 class="font-weight-bold mb-0">Mutual Hub <span class="badge badge-light border ml-2" style="font-size:0.6rem">PRO</span></h5>
        </div>
        <div id="idContainer" class="d-none">
            <div class="bg-white border px-3 py-2 rounded-xl d-flex align-items-center shadow-sm">
                <small class="font-weight-bold mr-3" id="lblUserPhone">00...00</small>
                <i class="fas fa-power-off text-danger cursor-pointer" onclick="clearIdentity()"></i>
            </div>
        </div>
    </div>
</header>

<div class="container mt-4 pb-5">
    <div class="stat-container p-4 mb-4">
        <div class="row text-center">
            <div class="col-4 border-right">
                <div class="stat-label">Network Size</div>
                <div class="stat-value" id="statTotal">0</div>
            </div>
            <div class="col-4 border-right">
                <div class="stat-label">Successful Chains</div>
                <div class="stat-value text-primary" id="statMatched">0</div>
            </div>
            <div class="col-4">
                <div class="stat-label">Efficiency</div>
                <div class="stat-value text-success" id="statRate">0%</div>
            </div>
        </div>
    </div>

    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active font-weight-bold" data-toggle="pill" href="#paneListings">Live Listings</a>
        </li>
        <li class="nav-item ml-2">
            <a class="nav-link font-weight-bold" data-toggle="pill" href="#paneActivity" onclick="loadActivityLog()">Intelligence Hub</a>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="paneListings">
            <div class="bg-white p-4 mb-4 shadow-sm">
                <div class="row">
                    <div class="col-md-5 mb-3">
                        <label class="small font-weight-bold text-muted">SEARCH DESIGNATION</label>
                        <input id="inpSearch" class="form-control" placeholder="Try 'Assistant'..." oninput="renderTable()" style="border-radius:12px; height:48px;">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="small font-weight-bold text-muted">MY MATCHES</label>
                        <button id="btnMatches" class="btn btn-outline-primary btn-block font-weight-bold" style="border-radius:12px; height:48px;" onclick="toggleMatches()">
                            Show Potential Matches
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-wrapper">
                <div class="table-responsive">
                    <table class="table m-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0 small font-weight-bold">EMPLOYEE</th>
                                <th class="border-0 small font-weight-bold">LOCATION</th>
                                <th class="border-0 small font-weight-bold">TARGET</th>
                                <th class="border-0 small font-weight-bold">STATUS</th>
                                <th class="border-0 small font-weight-bold text-center">ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="mainTbody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="paneActivity">
            <div class="row">
                <div class="col-md-7">
                    <h6 class="font-weight-bold text-muted mb-3">MATCH INTENSITY</h6>
                    <div id="notificationList"></div>
                </div>
                <div class="col-md-5">
                    <h6 class="font-weight-bold text-muted mb-3">DEMAND TRENDS</h6>
                    <div class="p-3 bg-white border rounded-24">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="font-weight-bold">District Popularity</small>
                            <span class="badge badge-success">Rising <i class="fas fa-arrow-trend-up"></i></span>
                        </div>
                        <canvas id="trendChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalContact" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 p-4" style="border-radius:30px;">
            <div class="text-center">
                <div class="small font-weight-bold text-success mb-3">MATCH VERIFIED <i class="fas fa-check-circle"></i></div>
                
                <div id="corridorContainer" class="mb-4">
                    <div class="d-flex justify-content-around align-items-center">
                        <div class="corridor-node">
                            <div class="node-circle"><i class="fas fa-user"></i></div>
                            <div id="nodeMe" class="small font-weight-bold">---</div>
                        </div>
                        <div class="text-primary px-3">
                            <i class="fas fa-right-left fa-lg"></i>
                        </div>
                        <div class="corridor-node">
                            <div class="node-circle" style="border-color:var(--success); color:var(--success)"><i class="fas fa-handshake"></i></div>
                            <div id="nodeThem" class="small font-weight-bold">---</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span id="matchTypePill" class="badge badge-pill badge-primary px-3">Direct Mutual</span>
                    </div>
                </div>

                <h2 id="resName" class="font-weight-bold mb-1">---</h2>
                <div id="trustScoreArea" class="mb-4"></div>

                <div class="bg-light p-4 rounded-24 mb-4 border">
                    <span class="text-muted small font-weight-bold uppercase">MOBILE CONTACT</span>
                    <h1 class="text-dark font-weight-bold mb-0" id="resPhone">---</h1>
                </div>

                <div class="row">
                    <div class="col-6"><a id="callLink" class="btn btn-primary btn-block py-3 font-weight-bold rounded-15"><i class="fas fa-phone mr-2"></i>Call</a></div>
                    <div class="col-6"><a id="waLink" target="_blank" class="btn btn-success btn-block py-3 font-weight-bold rounded-15"><i class="fab fa-whatsapp mr-2"></i>WhatsApp</a></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVerify" tabindex="-1" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 p-4 rounded-24 shadow-lg text-center">
            <div class="bg-primary text-white d-inline-block p-3 rounded-circle mx-auto mb-3 shadow">
                <i class="fas fa-user-lock fa-2x"></i>
            </div>
            <h4 class="font-weight-bold">Welcome Back</h4>
            <p class="text-muted small">Please verify your number to access matches.</p>
            <input id="verifyPhone" type="tel" maxlength="10" class="form-control text-center font-weight-bold mb-3" style="height:60px; font-size:1.5rem; border-radius:15px;" placeholder="10-digit Number">
            <button class="btn btn-primary btn-block py-3 font-weight-bold rounded-15" onclick="saveVerify()">Sync Dashboard</button>
            <div id="regSection" style="display:none;" class="mt-3">
                <p class="small">New here? <a href="https://dhileepank2-web.github.io/mutual-transfer-dash/Registration.html" class="font-weight-bold">Register Now</a></p>
            </div>
        </div>
    </div>
</div>

<footer class="text-center py-4 text-muted small">
    <div class="container">
        <i class="fas fa-heart-pulse text-success mr-2"></i> System Integrity: Encrypted | Last Global Sync: <span id="lastUpdated">...</span>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script>
    const API = "https://script.google.com/macros/s/AKfycbzpOofnWNMX_9k0alBViu1rq54ReVdR7VUhqs28WYYlansyFXuX58CxRqnDz_KU_zLO/exec";
    let MASTER_DATA = [], FILTER_MATCHES = false, MY_PHONE = localStorage.getItem("userPhone");

    $(document).ready(() => {
        showSkeletons();
        loadData();
    });

    /**
     * Data Engine
     */
    function loadData() {
        fetch(`${API}?action=getDashboardData&t=${Date.now()}`)
        .then(r => r.json())
        .then(response => {
            MASTER_DATA = response.records || [];
            
            // Check Identity
            if (MY_PHONE) {
                const user = MASTER_DATA.find(x => String(x.phone) === String(MY_PHONE));
                if (user) {
                    $('#idContainer').removeClass('d-none');
                    $('#lblUserPhone').text(MY_PHONE.slice(0, 2) + '****' + MY_PHONE.slice(-2));
                } else {
                    localStorage.removeItem("userPhone");
                    MY_PHONE = null;
                    $('#modalVerify').modal('show');
                }
            } else {
                $('#modalVerify').modal('show');
            }

            $('#lastUpdated').text(response.serverTime || new Date().toLocaleTimeString());
            updateStats(MASTER_DATA, response.archivedCount || 0);
            renderTable();
            $("#globalLoader").fadeOut();
        })
        .catch(e => { console.error(e); $("#globalLoader").hide(); });
    }

    /**
     * UI: Skeleton Loading
     */
    function showSkeletons() {
        const tbody = $('#mainTbody');
        let skeletonHtml = "";
        for(let i=0; i<6; i++) {
            skeletonHtml += `
                <tr>
                    <td><div class="skeleton" style="width:140px"></div></td>
                    <td><div class="skeleton" style="width:100px"></div></td>
                    <td><div class="skeleton" style="width:100px"></div></td>
                    <td><div class="skeleton" style="width:80px"></div></td>
                    <td class="text-center"><div class="skeleton" style="width:40px; height:40px; border-radius:12px"></div></td>
                </tr>`;
        }
        tbody.html(skeletonHtml);
    }

    /**
     * Feature: Visual Flow & Contact Unlock
     */
    async function unlockRow(id, hasMatch) {
        if(!hasMatch) { alert("Matches are automatically unlocked once a mutual connection is found."); return; }
        
        const target = MASTER_DATA.find(x => x.id === id);
        const me = MASTER_DATA.find(x => String(x.phone) === String(MY_PHONE));

        // Visualize Corridor
        if(target && me) {
            $('#nodeMe').text(me['Working District']);
            $('#nodeThem').text(target['Working District']);
            const is3Way = target.MATCH_STATUS.toUpperCase().includes("3-WAY");
            $('#matchTypePill').text(is3Way ? "3-WAY CHAIN MATCH" : "DIRECT MUTUAL")
                              .toggleClass('badge-secondary', is3Way)
                              .toggleClass('badge-primary', !is3Way);
        }

        $("#globalLoader").fadeIn();
        try {
            const res = await fetch(API, {
                method: "POST",
                body: JSON.stringify({ action: "getContact", rowId: id, userPhone: MY_PHONE })
            });
            const data = await res.json();
            $("#globalLoader").fadeOut();
            
            if(data.error) alert(data.error);
            else {
                $('#resName').text(data.name);
                $('#resPhone').text(data.contact);
                
                // Trust Score Calculation
                const score = calculateTrustScore(data.joined);
                $('#trustScoreArea').html(`
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="progress flex-grow-1 mx-3" style="height:6px; border-radius:10px; max-width:200px;">
                            <div class="progress-bar bg-success" style="width:${score}%"></div>
                        </div>
                        <small class="font-weight-bold text-success">${score}% Trust Score</small>
                    </div>
                `);

                $('#callLink').attr("href", "tel:" + data.contact);
                $('#waLink').attr("href", "https://wa.me/91" + data.contact);
                $('#modalContact').modal('show');
            }
        } catch(e) { $("#globalLoader").fadeOut(); alert("Unlock failed. Check connection."); }
    }

    /**
     * Feature: Match Intensity Indicator
     */
    function loadActivityLog() {
        const container = $('#notificationList').empty();
        const myEntries = MASTER_DATA.filter(x => String(x.phone) === String(MY_PHONE));
        
        if (!myEntries.length) return;

        myEntries.forEach(entry => {
            const isMatched = entry.MATCH_STATUS.toUpperCase().includes("MATCH");
            const progress = isMatched ? 100 : 65; // Simulated logic: if not matched, user is "searching" (65% towards a chain)
            
            container.append(`
                <div class="bg-white p-3 border rounded-24 mb-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small font-weight-bold text-uppercase">Chain Search: ${entry['Willing District']}</span>
                        <span class="font-weight-bold text-primary">${progress}%</span>
                    </div>
                    <div class="progress" style="height:8px; border-radius:10px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated ${isMatched ? 'bg-success' : 'bg-primary'}" style="width:${progress}%"></div>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        <i class="fas fa-circle-info mr-1"></i> ${isMatched ? 'Transfer corridor ready for verification.' : 'System exploring 3-way circular paths.'}
                    </small>
                </div>
            `);
        });
    }

    /**
     * Logic: Render Table
     */
    function renderTable() {
        const query = $('#inpSearch').val().toLowerCase();
        const tbody = $('#mainTbody');
        
        const filtered = MASTER_DATA.filter(r => {
            const matchesSearch = !query || r['Your Designation']?.toLowerCase().includes(query);
            if (FILTER_MATCHES) {
                // Logic to filter only potential matches for user
                return matchesSearch && r.MATCH_STATUS.toUpperCase().includes("MATCH");
            }
            return matchesSearch;
        });

        if (!filtered.length) {
            tbody.html('<tr><td colspan="5" class="text-center p-5 text-muted">No entries found matching criteria.</td></tr>');
            return;
        }

        let html = "";
        filtered.forEach(row => {
            const isMe = String(row.phone) === String(MY_PHONE);
            const hasMatch = row.MATCH_STATUS.toUpperCase().includes("MATCH");
            
            html += `
                <tr class="${isMe ? 'row-identity' : ''} ${hasMatch ? 'match-glow' : ''}">
                    <td>
                        <div class="font-weight-bold">${row['Your Designation']}</div>
                        ${isMe ? '<small class="text-primary font-weight-bold">OWN PROFILE</small>' : ''}
                    </td>
                    <td class="text-muted small"><i class="fas fa-location-dot mr-1"></i> ${row['Working District']}</td>
                    <td class="font-weight-bold"><i class="fas fa-plane-arrival text-primary mr-1"></i> ${row['Willing District']}</td>
                    <td>
                        <span class="badge badge-pill ${hasMatch ? 'badge-success' : 'badge-light border text-muted'}" style="font-size:0.65rem">
                            ${hasMatch ? (row.MATCH_STATUS.includes('3-WAY') ? '3-WAY MATCH' : 'DIRECT MATCH') : 'SEARCHING'}
                        </span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-unlock ${!hasMatch ? 'opacity-25' : ''}" onclick="unlockRow(${row.id}, ${hasMatch})">
                            <i class="fas ${hasMatch ? 'fa-lock-open' : 'fa-lock'}"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        tbody.html(html);
    }

    function calculateTrustScore(joinDate) {
        if (!joinDate) return 60;
        const days = Math.floor((new Date() - new Date(joinDate)) / (1000 * 60 * 60 * 24));
        return Math.min(100, 60 + (days * 2));
    }

    function updateStats(data, archived) {
        const liveTotal = [...new Set(data.map(x => x.phone))].length;
        const matched = data.filter(r => r.MATCH_STATUS.toUpperCase().includes("MATCH")).length + archived;
        const rate = Math.round((matched / (liveTotal + archived)) * 100) || 0;
        $('#statTotal').text(liveTotal);
        $('#statMatched').text(matched);
        $('#statRate').text(rate + '%');
    }

    function toggleMatches() {
        FILTER_MATCHES = !FILTER_MATCHES;
        $('#btnMatches').toggleClass('btn-primary text-white').toggleClass('btn-outline-primary');
        renderTable();
    }

    function saveVerify() {
        const val = $('#verifyPhone').val();
        if(!/^\d{10}$/.test(val)) { alert("Enter valid 10-digit number."); return; }
        if(MASTER_DATA.some(x => String(x.phone) === String(val))) {
            localStorage.setItem("userPhone", val);
            location.reload();
        } else {
            $('#regSection').fadeIn();
            alert("Number not found in active listings.");
        }
    }

    function clearIdentity() { localStorage.removeItem("userPhone"); location.reload(); }
    
    function redirectToRegistration() {
        window.location.href = "https://dhileepank2-web.github.io/mutual-transfer-dash/Registration.html";
    }
</script>
</body>
</html>
