<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mutual Transfer | Secure Portal</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: radial-gradient(circle at top right, #f8fafc, #eff6ff);
    color: #0f172a;
  }
  .input { 
    border: 1.5px solid #e2e8f0; 
    transition: all 0.2s ease;
  }
  .input:focus { 
    border-color: #2563eb; 
    box-shadow: 0 0 0 4px rgba(37,99,235,0.1); 
    outline: none;
    background-color: #fff;
  }
  .segment {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    background: #fff;
  }
  .segment.active { 
    background: #1e293b; 
    color: #fff; 
    border-color: #1e293b;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .mandatory::after { content: " *"; color: #ef4444; font-weight: bold; }
  
  @keyframes flash-bg {
    0%, 100% { background-color: #fef2f2; border-color: #fecaca; }
    50% { background-color: #fee2e2; border-color: #ef4444; }
  }
  .flash-update {
    animation: flash-bg 2s infinite ease-in-out;
  }

  .fade-in { animation: fadeIn 0.4s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .district-tag {
    background: #2563eb;
    color: white;
    padding: 4px 12px;
    border-radius: 99px;
    font-size: 12px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
    animation: fadeIn 0.2s ease-out;
  }
</style>
</head>

<body class="min-h-screen flex items-center justify-center p-4 py-12">

<div id="loader" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white p-8 rounded-2xl text-center shadow-2xl fade-in">
    <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
    <p class="mt-4 font-bold text-slate-800" id="loaderText">Processing...</p>
    <p class="text-xs text-slate-500 mt-1">Please do not refresh</p>
  </div>
</div>

<div class="bg-white/80 backdrop-blur-md w-full max-w-3xl rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.1)] p-8 md:p-12 border border-white/50 fade-in">

  <div id="updateBanner" class="flash-update border-2 rounded-2xl p-4 mb-8 flex items-center space-x-4">
    <div class="bg-red-500 text-white text-[10px] font-black px-2 py-1 rounded animate-pulse">ATTENTION</div>
    <p class="text-sm font-bold text-red-700">New Update: Multiple registrations & Multiple Willing Districts are now enabled!</p>
  </div>

  <header class="mb-10">
    <div class="inline-flex items-center space-x-2 bg-blue-50 px-3 py-1 rounded-full mb-4">
      <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
      <span id="badgeText" class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Instant Enrollment</span>
    </div>
    <h1 id="mainTitle" class="text-4xl font-extrabold tracking-tight text-slate-900">Registration</h1>
    <p id="subTitle" class="text-slate-500 mt-2 font-medium">Join the Mutual Transfer Network Portal</p>
  </header>

  <form id="regForm" class="space-y-8" onsubmit="event.preventDefault(); submitForm();">

    <div class="grid md:grid-cols-2 gap-8">
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Full Name</label>
        <input id="name" type="text" required class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800" placeholder="Enter Full Name">
      </div>
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Joining Date</label>
        <input id="doj" type="date" required class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800">
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Designation</label>
        <select id="designation" required onchange="handleRoleChange(this.value)" class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800 appearance-none">
          <option value="">Select Role</option>
          <option>Assistant</option>
          <option>Junior Assistant</option>
          <option>Typist</option>
          <option>Steno Typist</option>
          <option>WATCHMAN</option>
          <option>CLEANLINESS WORKER</option>
          <option>MASALCHI</option>
          <option>NIGHT WATCHMAN – CUM – MASALCHI</option>
          <option>MASALCHI CUM – NIGHT WATCHMAN</option>
          <option>OFFICE ASSISTANT</option>
          <option>COPYIST ATTENDER</option>
          <option>RECORD CLERK</option>
          <option>XEROX MACHINE OPERATOR (Adhoc Rules)</option>
          <option>JUNIOR BAILIFF</option>
          <option>DRIVER</option>
          <option>SENIOR BAILIFF</option>
          <option>BENCH CLERKS GRADE - III</option>
          <option>BENCH CLERKS GRADE - II</option>
          <option value="OTHER">OTHER (Specify below)</option>
        </select>
        <div id="otherRoleBox" class="hidden mt-3 fade-in">
            <input id="otherDesignation" type="text" class="input w-full rounded-xl px-4 py-3 border-blue-200 text-sm font-semibold text-slate-800" placeholder="Enter your designation">
        </div>
      </div>
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">WhatsApp Number</label>
        <input id="phone" maxlength="10" inputmode="numeric" required
               class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800"
               placeholder="10-digit mobile" oninput="livePhoneCheck(this)">
        <p id="phoneStatus" class="text-[10px] font-bold mt-2 ml-1 text-green-600">✓ Multi-registration active</p>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Probation Declared?</label>
        <div class="flex gap-3 mt-2" id="probationGroup">
          <button type="button" id="probation_Yes" class="segment flex-1 border border-slate-200 rounded-2xl py-3 font-bold text-sm" onclick="toggle('probation','Yes',this)">Yes</button>
          <button type="button" id="probation_No" class="segment active flex-1 border border-slate-200 rounded-2xl py-3 font-bold text-sm" onclick="toggle('probation','No',this)">No</button>
        </div>
        <input type="hidden" id="probation" value="No">
      </div>
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">COA Completed?</label>
        <div class="flex gap-3 mt-2" id="coaGroup">
          <button type="button" id="coa_Yes" class="segment flex-1 border border-slate-200 rounded-2xl py-3 font-bold text-sm" onclick="toggle('coa','Yes',this)">Yes</button>
          <button type="button" id="coa_No" class="segment active flex-1 border border-slate-200 rounded-2xl py-3 font-bold text-sm" onclick="toggle('coa','No',this)">No</button>
        </div>
        <input type="hidden" id="coa" value="No">
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Working District</label>
        <select id="workingDistrict" required class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800 appearance-none">
          <option value="">Syncing Districts...</option>
        </select>
      </div>
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Willing Districts (Multi-Select)</label>
        <select id="willingDistrictPicker" class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800 appearance-none" onchange="addDistrictTag(this.value)">
          <option value="">Select Districts...</option>
        </select>
        <div id="selectedDistrictsContainer" class="flex flex-wrap gap-2 mt-3 ml-1"></div>
      </div>
    </div>

    <hr class="border-slate-100 my-4">

    <div>
      <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Official Email</label>
      <input id="email" type="email" required class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800" placeholder="name@email.com">
    </div>

    <div class="pt-4">
      <button type="submit" id="submitBtn" 
        class="w-full bg-slate-900 hover:bg-black text-white py-5 rounded-2xl font-black uppercase tracking-widest transition-all shadow-xl shadow-slate-200">
        Complete Registration
      </button>
      <button type="button" id="cancelBtn" onclick="window.location.href='index.html'" class="hidden w-full mt-4 text-slate-400 font-bold text-sm hover:text-slate-600">
        Cancel Editing
      </button>
    </div>

  </form>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzpOofnWNMX_9k0alBViu1rq54ReVdR7VUhqs28WYYlansyFXuX58CxRqnDz_KU_zLO/exec";
let selectedWillingDistricts = [];
let IS_EDIT_MODE = false;

function toggle(field,val,btn){
  document.getElementById(field).value=val;
  if(btn){
    btn.parentElement.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  }
}

function handleRoleChange(val) {
    const box = document.getElementById('otherRoleBox');
    if(val === "OTHER") box.classList.remove('hidden');
    else { box.classList.add('hidden'); document.getElementById('otherDesignation').value = ""; }
}

function livePhoneCheck(input) {
  input.value = input.value.replace(/[^0-9]/g, '');
}

function addDistrictTag(val) {
  if(!val || selectedWillingDistricts.includes(val)) return;
  selectedWillingDistricts.push(val);
  renderDistrictTags();
  document.getElementById('willingDistrictPicker').value = "";
}

function removeDistrictTag(val) {
  selectedWillingDistricts = selectedWillingDistricts.filter(d => d !== val);
  renderDistrictTags();
}

function renderDistrictTags() {
  const container = document.getElementById('selectedDistrictsContainer');
  container.innerHTML = selectedWillingDistricts.map(d => `
    <div class="district-tag">
      ${d}
      <button type="button" onclick="removeDistrictTag('${d}')" class="hover:text-red-200 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  `).join('');
}

window.onload=()=>{
  const urlParams = new URLSearchParams(window.location.search);
  const editPhone = urlParams.get('editPhone');

  fetch(`${SCRIPT_URL}?action=getDistricts`)
  .then(r=>r.json())
  .then(d=>{
    const opt=d.map(x=>`<option value="${x}">${x}</option>`).join('');
    document.getElementById('workingDistrict').innerHTML='<option value="">Select Working District</option>'+opt;
    document.getElementById('willingDistrictPicker').innerHTML='<option value="">Add a Willing District...</option>'+opt;
    
    // If edit mode requested, start profile fetch
    if(editPhone) prepareEditMode(editPhone);
  });
};

async function prepareEditMode(phone) {
    document.getElementById('loader').classList.remove("hidden");
    document.getElementById('loaderText').innerText = "Fetching Profile...";
    
    try {
        // Use the specific checkPhone action to get the clean, un-flattened user data
        const res = await fetch(`${SCRIPT_URL}?action=checkPhone&phone=${phone}`);
        const data = await res.json();

        if(data.exists) {
            const user = data.userData;
            IS_EDIT_MODE = true;
            document.getElementById('mainTitle').innerText = "Update Profile";
            document.getElementById('submitBtn').innerText = "Save Changes";
            document.getElementById('cancelBtn').classList.remove('hidden');
            
            // 1. Map Text Fields
            document.getElementById('name').value = user.name || ''; 
            document.getElementById('phone').value = phone;
            document.getElementById('email').value = user.email || '';
            
            // 2. FIX: Date of Joining
            // The Apps Script helper 'formatDateForInput' sends yyyy-mm-dd
            if(user.doj) {
                document.getElementById('doj').value = user.doj;
            }

            // 3. Designation Logic
            const desigSelect = document.getElementById('designation');
            const role = user.designation;
            const exists = [...desigSelect.options].some(opt => opt.value === role);
            if(exists) {
                desigSelect.value = role;
            } else {
                desigSelect.value = "OTHER";
                document.getElementById('otherRoleBox').classList.remove('hidden');
                document.getElementById('otherDesignation').value = role;
            }

            // 4. FIX: Toggle States (Probation & COA)
            const probVal = user.probation || "No";
            const coaVal = user.coa || "No";
            toggle('probation', probVal, document.getElementById(`probation_${probVal}`));
            toggle('coa', coaVal, document.getElementById(`coa_${coaVal}`));

            // 5. Districts (Working)
            document.getElementById('workingDistrict').value = user.workingDistrict;
            
            // 6. FIX: Multi-District Logic
            // The Apps Script sends "District1, District2"
            if (user.willingDistrict) {
                selectedWillingDistricts = user.willingDistrict.split(',').map(s => s.trim()).filter(s => s !== "");
                renderDistrictTags();
            }

        } else {
            alert("Profile not found for this number.");
        }
    } catch (e) {
        console.error("Edit fetch error", e);
        alert("System error while fetching profile.");
    } finally {
        document.getElementById('loader').classList.add("hidden");
    }
}

async function submitForm() {
    // 1. Show Loader
    document.getElementById('loader').classList.remove("hidden");
    
    // 2. Prepare Data
    const newPhone = document.getElementById('phone').value.trim();
    // oldPhone is the number the user logged in with (stored in localStorage)
    const oldPhone = localStorage.getItem("userPhone"); 

    const payload = {
        action: "register",
        // Send oldPhone ONLY if we are in Edit Mode
        oldPhone: IS_EDIT_MODE ? oldPhone : null, 
       userData: {
            name: document.getElementById('name').value.trim(),
            designation: document.getElementById('designation').value === "OTHER" 
                ? document.getElementById('otherDesignation').value 
                : document.getElementById('designation').value,
            doj: document.getElementById('doj').value, 
            workingDistrict: document.getElementById('workingDistrict').value,
            willingDistrict: selectedWillingDistricts, 
            // FIX: Pull from hidden inputs updated by the toggle function
            probation: document.getElementById('probation').value,
            coa: document.getElementById('coa').value,
            phone: newPhone,
            email: document.getElementById('email').value.trim()
        }
    };

    try {
        const response = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();

        if (result.status === "SUCCESS") {
            // 3. AUTO-LOGIN SYNC
            // Overwrite the local storage with the new phone number
            localStorage.setItem("userPhone", result.newPhone);
            
            alert(IS_EDIT_MODE ? "✅ Profile updated successfully!" : "✅ Registered successfully!");
            
            // Redirect to Dashboard
            window.location.href = "testdash.html";
        } else {
            alert("❌ Error: " + result.error);
        }
    } catch (error) {
        console.error("Submission failed:", error);
        alert("❌ Failed to connect to server.");
    } finally {
        document.getElementById('loader').classList.add("hidden");
    }
}
</script>
</body>
</html>
