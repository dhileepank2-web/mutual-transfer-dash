<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mutual Transfer | Secure Portal</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: radial-gradient(circle at top right, #f8fafc, #eff6ff);
    color: #0f172a;
  }
  .input { 
    border: 1.5px solid #e2e8f0; 
    transition: all 0.2s ease;
  }
  .input:focus { 
    border-color: #2563eb; 
    box-shadow: 0 0 0 4px rgba(37,99,235,0.1); 
    outline: none;
    background-color: #fff;
  }
  .segment {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    background: #fff;
  }
  .segment.active { 
    background: #1e293b; 
    color: #fff; 
    border-color: #1e293b;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .mandatory::after { content: " *"; color: #ef4444; font-weight: bold; }
  
  @keyframes flash-bg {
    0%, 100% { background-color: #fef2f2; border-color: #fecaca; }
    50% { background-color: #fee2e2; border-color: #ef4444; }
  }
  .flash-update {
    animation: flash-bg 2s infinite ease-in-out;
  }

  .fade-in { animation: fadeIn 0.4s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .district-tag {
    background: #2563eb;
    color: white;
    padding: 4px 12px;
    border-radius: 99px;
    font-size: 12px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
    animation: fadeIn 0.2s ease-out;
  }
</style>
</head>

<body class="min-h-screen flex items-center justify-center p-4 py-12">

<div id="loader" class="hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50">
  <div class="bg-white p-8 rounded-2xl text-center shadow-2xl fade-in">
    <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
    <p class="mt-4 font-bold text-slate-800" id="loaderText">Processing...</p>
    <p class="text-xs text-slate-500 mt-1">Please do not refresh</p>
  </div>
</div>

<div class="bg-white/80 backdrop-blur-md w-full max-w-3xl rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.1)] p-8 md:p-12 border border-white/50 fade-in">

  <div id="updateBanner" class="flash-update border-2 rounded-2xl p-4 mb-8 flex items-center space-x-4">
    <div class="bg-red-500 text-white text-[10px] font-black px-2 py-1 rounded animate-pulse">ATTENTION</div>
    <p class="text-sm font-bold text-red-700">New Update: Multiple registrations & Multiple Willing Districts are now enabled!</p>
  </div>

  <header class="mb-10">
    <div class="inline-flex items-center space-x-2 bg-blue-50 px-3 py-1 rounded-full mb-4">
      <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
      <span id="badgeText" class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Instant Enrollment</span>
    </div>
    <h1 id="mainTitle" class="text-4xl font-extrabold tracking-tight text-slate-900">Registration</h1>
    <p id="subTitle" class="text-slate-500 mt-2 font-medium">Join the Mutual Transfer Network Portal</p>
  </header>

  <form id="regForm" class="space-y-8" onsubmit="event.preventDefault(); submitForm();">

    <div class="grid md:grid-cols-2 gap-8">
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Full Name</label>
        <input id="name" type="text" required class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800" placeholder="Enter Full Name">
      </div>
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Joining Date</label>
        <input id="doj" type="date" required class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800">
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Designation</label>
        <select id="designation" required onchange="handleRoleChange(this.value)" class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800 appearance-none">
          <option value="">Select Role</option>
          <option>Assistant</option>
          <option>Junior Assistant</option>
          <option>Typist</option>
          <option>Steno Typist</option>
          <option>WATCHMAN</option>
          <option>CLEANLINESS WORKER</option>
          <option>MASALCHI</option>
          <option>NIGHT WATCHMAN – CUM – MASALCHI</option>
          <option>MASALCHI CUM – NIGHT WATCHMAN</option>
          <option>OFFICE ASSISTANT</option>
          <option>COPYIST ATTENDER</option>
          <option>RECORD CLERK</option>
          <option>XEROX MACHINE OPERATOR (Adhoc Rules)</option>
          <option>JUNIOR BAILIFF</option>
          <option>DRIVER</option>
          <option>SENIOR BAILIFF</option>
          <option>BENCH CLERKS GRADE - III</option>
          <option>BENCH CLERKS GRADE - II</option>
          <option value="OTHER">OTHER (Specify below)</option>
        </select>
        <div id="otherRoleBox" class="hidden mt-3 fade-in">
            <input id="otherDesignation" type="text" class="input w-full rounded-xl px-4 py-3 border-blue-200 text-sm font-semibold text-slate-800" placeholder="Enter your designation">
        </div>
      </div>
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">WhatsApp Number</label>
        <input id="phone" maxlength="10" inputmode="numeric" required
               class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800"
               placeholder="10-digit mobile" oninput="livePhoneCheck(this)">
        <p id="phoneStatus" class="text-[10px] font-bold mt-2 ml-1 text-green-600">✓ Multi-registration active</p>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Probation Declared?</label>
        <div class="flex gap-3 mt-2" id="probationGroup">
          <button type="button" id="probation_Yes" class="segment flex-1 border border-slate-200 rounded-2xl py-3 font-bold text-sm" onclick="toggle('probation','Yes',this)">Yes</button>
          <button type="button" id="probation_No" class="segment active flex-1 border border-slate-200 rounded-2xl py-3 font-bold text-sm" onclick="toggle('probation','No',this)">No</button>
        </div>
        <input type="hidden" id="probation" value="No">
      </div>
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">COA Completed?</label>
        <div class="flex gap-3 mt-2" id="coaGroup">
          <button type="button" id="coa_Yes" class="segment flex-1 border border-slate-200 rounded-2xl py-3 font-bold text-sm" onclick="toggle('coa','Yes',this)">Yes</button>
          <button type="button" id="coa_No" class="segment active flex-1 border border-slate-200 rounded-2xl py-3 font-bold text-sm" onclick="toggle('coa','No',this)">No</button>
        </div>
        <input type="hidden" id="coa" value="No">
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Working District</label>
        <select id="workingDistrict" required class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800 appearance-none">
          <option value="">Syncing Districts...</option>
        </select>
      </div>
      <div>
        <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Willing Districts (Multi-Select)</label>
        <select id="willingDistrictPicker" class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800 appearance-none" onchange="addDistrictTag(this.value)">
          <option value="">Select Districts...</option>
        </select>
        <div id="selectedDistrictsContainer" class="flex flex-wrap gap-2 mt-3 ml-1"></div>
      </div>
    </div>

    <hr class="border-slate-100 my-4">

    <div>
      <label class="mandatory text-[11px] font-extrabold text-slate-400 uppercase tracking-wider ml-1">Official Email</label>
      <input id="email" type="email" required class="input w-full rounded-2xl px-5 py-4 mt-2 font-semibold text-slate-800" placeholder="name@email.com">
    </div>

    <div class="pt-4">
      <button type="submit" id="submitBtn" 
        class="w-full bg-slate-900 hover:bg-black text-white py-5 rounded-2xl font-black uppercase tracking-widest transition-all shadow-xl shadow-slate-200">
        Complete Registration
      </button>
      <button type="button" id="cancelBtn" onclick="location.reload()" class="hidden w-full mt-4 text-slate-400 font-bold text-sm hover:text-slate-600">
        Cancel Editing
      </button>
    </div>

  </form>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzpOofnWNMX_9k0alBViu1rq54ReVdR7VUhqs28WYYlansyFXuX58CxRqnDz_KU_zLO/exec";
let selectedWillingDistricts = [];
let IS_EDIT_MODE = false;

function toggle(field,val,btn){
  document.getElementById(field).value=val;
  btn.parentElement.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function handleRoleChange(val) {
    const box = document.getElementById('otherRoleBox');
    if(val === "OTHER") box.classList.remove('hidden');
    else { box.classList.add('hidden'); document.getElementById('otherDesignation').value = ""; }
}

function livePhoneCheck(input) {
  input.value = input.value.replace(/[^0-9]/g, '');
}

function addDistrictTag(val) {
  if(!val || selectedWillingDistricts.includes(val)) return;
  selectedWillingDistricts.push(val);
  renderDistrictTags();
  document.getElementById('willingDistrictPicker').value = "";
}

function removeDistrictTag(val) {
  selectedWillingDistricts = selectedWillingDistricts.filter(d => d !== val);
  renderDistrictTags();
}

function renderDistrictTags() {
  const container = document.getElementById('selectedDistrictsContainer');
  container.innerHTML = selectedWillingDistricts.map(d => `
    <div class="district-tag">
      ${d}
      <button type="button" onclick="removeDistrictTag('${d}')" class="hover:text-red-200 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  `).join('');
}

window.onload=()=>{
  const urlParams = new URLSearchParams(window.location.search);
  const editPhone = urlParams.get('edit');

  fetch(`${SCRIPT_URL}?action=getDistricts`)
  .then(r=>r.json())
  .then(d=>{
    const opt=d.map(x=>`<option value="${x}">${x}</option>`).join('');
    document.getElementById('workingDistrict').innerHTML='<option value="">Select Working District</option>'+opt;
    document.getElementById('willingDistrictPicker').innerHTML='<option value="">Add a Willing District...</option>'+opt;
    
    // If edit mode, fetch user data after districts are loaded
    if(editPhone) prepareEditMode(editPhone);
  });
};

async function prepareEditMode(phone) {
    document.getElementById('loader').classList.remove("hidden");
    document.getElementById('loaderText').innerText = "Fetching Profile...";
    
    try {
        const res = await fetch(`${SCRIPT_URL}?action=getDashboardData`);
        const data = await res.json();
        const user = data.records.find(r => String(r.phone) === String(phone));

        if(user) {
            IS_EDIT_MODE = true;
            document.getElementById('mainTitle').innerText = "Update Profile";
            document.getElementById('subTitle').innerText = "Modify your transfer preferences";
            document.getElementById('submitBtn').innerText = "Save Changes";
            document.getElementById('badgeText').innerText = "Verified Edit Mode";
            document.getElementById('cancelBtn').classList.remove('hidden');
            document.getElementById('phone').readOnly = true;
            document.getElementById('phoneStatus').innerText = "✓ Phone number locked during edit";

            // Fill basic info
            document.getElementById('name').value = user['Full Name'] || '';
            document.getElementById('phone').value = user['phone'];
            document.getElementById('email').value = user['Email Address'] || '';
            
            // Handle Date (Format YYYY-MM-DD for input)
            if(user['Joining Date']) {
                const date = new Date(user['Joining Date']);
                document.getElementById('doj').value = date.toISOString().split('T')[0];
            }

            // Handle Designation
            const desigSelect = document.getElementById('designation');
            const roleExists = [...desigSelect.options].some(opt => opt.value === user['Your Designation']);
            if(roleExists) {
                desigSelect.value = user['Your Designation'];
            } else {
                desigSelect.value = "OTHER";
                document.getElementById('otherRoleBox').classList.remove('hidden');
                document.getElementById('otherDesignation').value = user['Your Designation'];
            }

            // Handle Toggles
            toggle('probation', user['Probation Declared?'], document.getElementById(`probation_${user['Probation Declared?']}`));
            toggle('coa', user['COA Completed?'], document.getElementById(`coa_${user['COA Completed?']}`));

            // Handle Districts
            document.getElementById('workingDistrict').value = user['Working District'];
            
            // Handle Willing Districts (Comma to Array)
            const willingStr = user['Willing District'] || "";
            selectedWillingDistricts = willingStr.split(',').map(s => s.trim()).filter(s => s !== "");
            renderDistrictTags();

        }
    } catch (e) {
        console.error("Edit mode error", e);
    } finally {
        document.getElementById('loader').classList.add("hidden");
    }
}

function submitForm() {
    const phone = document.getElementById('phone').value;
    if(phone.length !== 10) return alert("Please enter a valid 10-digit mobile number.");
    if(selectedWillingDistricts.length === 0) return alert("Please select at least one Willing District.");

    const mainRole = document.getElementById('designation').value;
    const finalRole = (mainRole === "OTHER") ? document.getElementById('otherDesignation').value : mainRole;
    if(!finalRole) return alert("Designation is required");

    document.getElementById('loader').classList.remove("hidden");
    document.getElementById('loaderText').innerText = IS_EDIT_MODE ? "Updating..." : "Registering...";

    const payload = {
        action: IS_EDIT_MODE ? "updateProfile" : "register",
        userPhone: phone, // for update action identification
        userData: {
            name: document.getElementById('name').value,
            doj: document.getElementById('doj').value,
            designation: finalRole,
            phone: phone,
            probation: document.getElementById('probation').value,
            coa: document.getElementById('coa').value,
            workingDistrict: document.getElementById('workingDistrict').value,
            willingDistrict: selectedWillingDistricts.join(", "),
            email: document.getElementById('email').value
        }
    };

    fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(res => {
        document.getElementById('loader').classList.add("hidden");
        if (res.status === "SUCCESS") { 
            alert(IS_EDIT_MODE ? "✅ Profile Updated Successfully!" : "✅ Registered Successfully!"); 
            // Redirect back to dashboard if possible, else reload
            window.location.href = "index.html"; 
        }
        else alert(res.message || res.error || "Operation failed.");
    })
    .catch(err => {
        document.getElementById('loader').classList.add("hidden");
        alert("Operation failed. Please check your connection.");
    });
}
</script>
</body>
</html>
