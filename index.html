<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Transfer Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .dashboard-header { background: white; border-bottom: 1px solid #e2e8f0; padding: 15px 0; position: sticky; top:0; z-index:100; }
        .stat-card { background: white; border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-card h2 { font-size: 0.7rem; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
        .stat-card p { font-size: 1.4rem; color: var(--primary); font-weight: 700; margin: 0; }
        .filter-section { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .table-container { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; }
        .badge-match { background: #dcfce7; color: #166534; font-weight: 600; }
        .badge-demand { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; font-size: 0.7rem; }
        .mobile-card { display: none; background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        @media (max-width: 768px) { .desktop-only { display: none; } .mobile-card { display: block; } }
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center; z-index:9999; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner-border text-primary"></div></div>

<div class="dashboard-header mb-4">
    <div class="container d-flex justify-content-between align-items-center">
        <h5 class="m-0 font-weight-bold text-primary"><i class="fas fa-exchange-alt mr-2"></i>Mutual Live</h5>
        <button id="authBtn" class="btn btn-sm btn-outline-secondary" onclick="logout()">Not Verified</button>
    </div>
</div>

<div class="container">
    <div class="row no-gutters mb-4">
        <div class="col-4 px-1"><div class="stat-card"><h2>Total</h2><p id="sTotal">0</p></div></div>
        <div class="col-4 px-1"><div class="stat-card"><h2>Matches</h2><p id="sMatch">0</p></div></div>
        <div class="col-4 px-1"><div class="stat-card"><h2>Rate</h2><p id="sRate">0%</p></div></div>
    </div>

    <div class="filter-section">
        <div class="row">
            <div class="col-md-6 mb-2">
                <input type="text" id="search" class="form-control" placeholder="Search District or Role..." onkeyup="render()">
            </div>
            <div class="col-md-6 mb-2">
                <select id="fStat" class="form-control" onchange="render()">
                    <option value="all">All Status</option>
                    <option value="MATCH FOUND">Match Found</option>
                </select>
            </div>
        </div>
    </div>

    <div class="table-container desktop-only shadow-sm">
        <table class="table m-0">
            <thead class="thead-dark">
                <tr><th>Designation</th><th>From</th><th>To</th><th>Demand</th><th>Status</th><th>Action</th></tr>
            </thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
    <div id="mBody" class="d-md-none"></div>
</div>

<div class="modal fade" id="cModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="border-radius:20px;">
            <div class="modal-body text-center p-5">
                <div class="text-success mb-3"><i class="fas fa-check-circle fa-4x"></i></div>
                <h4 id="resName" class="font-weight-bold">---</h4>
                <p id="resPhone" class="h4 text-primary my-4">---</p>
                <div class="row">
                    <div class="col-6"><a id="call" href="#" class="btn btn-primary btn-block py-2"><i class="fas fa-phone mr-2"></i>Call</a></div>
                    <div class="col-6"><a id="wa" href="#" target="_blank" class="btn btn-success btn-block py-2"><i class="fab fa-whatsapp mr-2"></i>WhatsApp</a></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="vModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-body text-center p-4">
                <h5 class="font-weight-bold mb-3">Verify Identity</h5>
                <input type="tel" id="uPhone" class="form-control text-center mb-3" placeholder="Enter Registered Phone">
                <button class="btn btn-primary btn-block" onclick="saveAuth()">Unlock Contacts</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script>
    const SCRIPT_URL = "YOUR_DEPLOYED_WEBAPP_URL_HERE"; 
    let db = [], activeId = null;

    $(document).ready(() => { checkAuth(); load(); });

    function load() {
        $('#loader').show();
        fetch(SCRIPT_URL).then(r => r.json()).then(data => { db = data; render(); $('#loader').hide(); });
    }

    function render() {
        const q = $('#search').val().toLowerCase();
        const s = $('#fStat').val();
        const filtered = db.filter(r => {
            const matchQuery = r['Your Designation'].toLowerCase().includes(q) || r['Working District'].toLowerCase().includes(q) || r['Willing District'].toLowerCase().includes(q);
            const matchStatus = s === 'all' || r.MATCH_STATUS === s;
            return matchQuery && matchStatus;
        });

        $('#sTotal').text(db.length);
        $('#sMatch').text(db.filter(x => x.MATCH_STATUS === 'MATCH FOUND').length);
        
        const tb = $('#tBody').empty();
        const mb = $('#mBody').empty();

        filtered.forEach(r => {
            const isM = r.MATCH_STATUS === 'MATCH FOUND';
            const dBadge = r.DEMAND_STATUS.includes('HIGH') ? `<span class="badge badge-demand"><i class="fas fa-fire mr-1"></i>High</span>` : `<small class="text-muted">${r.DEMAND_STATUS}</small>`;
            const sBadge = isM ? `<span class="badge badge-match">FOUND</span>` : `<span class="badge badge-light">PENDING</span>`;
            const btn = isM ? `<button onclick="view(${r.id})" class="btn btn-primary btn-sm px-3">View</button>` : `<button class="btn btn-light btn-sm" disabled>Wait</button>`;

            tb.append(`<tr><td>${r['Your Designation']}</td><td>${r['Working District']}</td><td>${r['Willing District']}</td><td>${dBadge}</td><td>${sBadge}</td><td>${btn}</td></tr>`);
            mb.append(`<div class="mobile-card"><div class="d-flex justify-content-between"><b>${r['Your Designation']}</b>${sBadge}</div><div class="row mt-2"><div class="col-6"><small>FROM</small><div>${r['Working District']}</div></div><div class="col-6"><small>TO</small><div>${r['Willing District']}</div></div></div><div class="d-flex justify-content-between align-items-center mt-2">${dBadge}${btn}</div></div>`);
        });
    }

    function view(id) {
        activeId = id;
        const p = localStorage.getItem('up');
        p ? fetchContact(id, p) : $('#vModal').modal('show');
    }

    function saveAuth() {
        const p = $('#uPhone').val();
        if(p.length < 10) return alert("Invalid Phone");
        localStorage.setItem('up', p);
        $('#vModal').modal('hide');
        checkAuth();
        fetchContact(activeId, p);
    }

    function fetchContact(id, phone) {
        $('#loader').show();
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ rowId: id, userPhone: phone }) })
        .then(r => r.json()).then(res => {
            $('#loader').hide();
            if(res.error) { alert(res.error); logout(); }
            else {
                $('#resName').text(res.name);
                $('#resPhone').text(res.contact);
                const c = res.contact.replace(/\D/g,'');
                $('#call').attr('href', 'tel:'+c);
                $('#wa').attr('href', 'https://wa.me/'+c);
                $('#cModal').modal('show');
            }
        });
    }

    function checkAuth() {
        const p = localStorage.getItem('up');
        if(p) $('#authBtn').text('Verified: ***'+p.slice(-4)).removeClass('btn-outline-secondary').addClass('btn-success');
    }

    function logout() { localStorage.removeItem('up'); location.reload(); }
</script>
</body>
</html>
