<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Mutual Transfer Live Dashboard</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <style>
    /* Custom Styles */
    body {
      padding: 20px;
      background-color: #f8f9fa;
      font-family: 'Roboto', sans-serif;
    }
    .header-box {
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .header-box h2 {
      font-size: 1.2rem;
      color: #6c757d;
      font-weight: 300;
      margin-bottom: 10px;
    }
    .header-box p {
      font-size: 2.5rem;
      color: #007bff;
      font-weight: 700;
      margin: 0;
    }
    #dashboard-title {
      color: #007bff;
      font-weight: 700;
      margin-bottom: 20px;
    }
    .table-container {
      overflow-x: auto; /* Ensures horizontal scrolling for narrow screens (Mobile Fix) */
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 15px;
    }
    #transferTable th {
      background-color: #007bff;
      color: white;
      text-transform: uppercase;
      font-size: 0.8rem;
      white-space: nowrap; /* Prevent headers from wrapping */
    }
    #transferTable td {
      font-size: 0.9rem;
      white-space: nowrap;
    }
    .action-cell {
      min-width: 120px; /* Prevent button from wrapping */
    }
    /* Mobile filter stack fix */
    @media (max-width: 767.98px) {
      .filter-row .col-md-3 {
        margin-bottom: 10px;
      }
    }

    /* Loading Spinner */
    .spinner-border {
      width: 3rem;
      height: 3rem;
      margin: 50px auto;
      display: block;
    }
  </style>
</head>
<body>

  <div class="container-fluid">
    <h1 id="dashboard-title">Mutual Transfer Live Dashboard</h1>
    <div class="text-right text-muted mb-3">Logged in as: <?= email ?></div>

    <div class="row">
      <div class="col-md-4 col-sm-12">
        <div class="header-box">
          <h2>Total Active Requests</h2>
          <p id="totalRequests">0</p>
        </div>
      </div>
      <div class="col-md-4 col-sm-12">
        <div class="header-box">
          <h2>Total Mutual Matches</h2>
          <p id="totalMatches">0</p>
        </div>
      </div>
      <div class="col-md-4 col-sm-12">
        <div class="header-box">
          <h2>Success Rate</h2>
          <p id="successRate">0.0%</p>
        </div>
      </div>
    </div>

    <div class="row mb-4 bg-light p-3 rounded shadow-sm filter-row">
      <div class="col-md-3">
        <label for="filterDesignation" class="sr-only">Filter Designation</label>
        <select id="filterDesignation" class="form-control" onchange="filterTable()"></select>
      </div>
      <div class="col-md-3">
        <label for="filterWorking" class="sr-only">Filter Working (FROM)</label>
        <select id="filterWorking" class="form-control" onchange="filterTable()"></select>
      </div>
      <div class="col-md-3">
        <label for="filterWilling" class="sr-only">Filter Willing (TO)</label>
        <select id="filterWilling" class="form-control" onchange="filterTable()"></select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-secondary btn-block" onclick="clearFilters()">Clear Filters</button>
      </div>
    </div>

    <h3>Transfer Requests</h3>
    
    <div id="loading" class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <p>Loading data...</p>
    </div>

    <div class="table-container" style="display: none;">
      <table id="transferTable" class="table table-striped table-hover table-sm">
        <thead>
          <tr>
            <th>Designation</th>
            <th>Working (FROM)</th>
            <th>Willing (TO)</th>
            <th>Date of Joining (DD-MM-YYYY)</th>
            <th>Probation Declared?</th>
            <th>COA Completed?</th>
            <th>Demand Status</th>
            <th>Match Status</th>
            <th class="action-cell">Action</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
    </div>
    
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="contactModalLabel">Contact Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p><strong>Name:</strong> <span id="contactName"></span></p>
            <p><strong>Contact Number:</strong> <span id="contactNumber"></span></p>
            <p class="text-danger small">NOTE: Accessing this information is logged for security and audit purposes. Your email has been recorded in the Log_Viewed_By column.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
  <script>
    let allData = [];
    let filterValues = {}; // Holds unique values for dropdowns

    // 1. Initial Data Fetch
$(document).ready(function() {
  const scriptUrl = "https://script.google.com/macros/s/AKfycbwEDsxnfueDEQROnUckRjcPX3E5ph47xe0WqHTA5uc_2bIRz-oJl__SmuDpLBTFBv9ZVw/exec"; // Paste URL from Step 1
  
  fetch(scriptUrl)
    .then(response => response.json())
    .then(data => {
       renderData(data); // Your existing render function
    })
    .catch(error => {
       handleError(error);
    });
});

    // 2. Data Renderer and Filter Initialization
    function renderData(data) {
      $('#loading').hide();
      $('.table-container').show();
      allData = data;
      updateMetrics(data);
      extractFilterValues(data);
      populateFilters();
      filterTable(); // Initially render all data
    }

    // 3. Update Metrics (KPIs)
    function updateMetrics(data) {
      const totalRequests = data.length;
      const totalMatches = data.filter(row => row.MATCH_STATUS === 'MATCH FOUND').length;
      const successRate = totalRequests > 0 ? ((totalMatches / totalRequests) * 100).toFixed(1) : 0.0;

      $('#totalRequests').text(totalRequests);
      $('#totalMatches').text(totalMatches);
      $('#successRate').text(successRate + '%');
    }

    // 4. Extract Unique Filter Values
    function extractFilterValues(data) {
      filterValues = {
        'Your Designation': ['-- All Designations --'],
        'Working District': ['-- All Districts --'],
        'Willing District': ['-- All Districts --']
      };
      data.forEach(row => {
        if (row['Your Designation'] && !filterValues['Your Designation'].includes(row['Your Designation'])) {
          filterValues['Your Designation'].push(row['Your Designation']);
        }
        if (row['Working District'] && !filterValues['Working District'].includes(row['Working District'])) {
          filterValues['Working District'].push(row['Working District']);
        }
        if (row['Willing District'] && !filterValues['Willing District'].includes(row['Willing District'])) {
          filterValues['Willing District'].push(row['Willing District']);
        }
      });
    }

    // 5. Populate Dropdowns
    function populateFilters() {
      const designationSelect = $('#filterDesignation');
      const workingSelect = $('#filterWorking');
      const willingSelect = $('#filterWilling');

      designationSelect.empty();
      workingSelect.empty();
      willingSelect.empty();

      filterValues['Your Designation'].sort().forEach(val => {
        designationSelect.append(`<option value="${val}">${val}</option>`);
      });
      filterValues['Working District'].sort().forEach(val => {
        workingSelect.append(`<option value="${val}">${val}</option>`);
      });
      filterValues['Willing District'].sort().forEach(val => {
        willingSelect.append(`<option value="${val}">${val}</option>`);
      });
    }

    // 6. Filter and Render Table Data
    function filterTable() {
      const designation = $('#filterDesignation').val();
      const working = $('#filterWorking').val();
      const willing = $('#filterWilling').val();

      const filteredData = allData.filter(row => {
        const matchesDesignation = (designation === '-- All Designations --' || row['Your Designation'] === designation);
        const matchesWorking = (working === '-- All Districts --' || row['Working District'] === working);
        const matchesWilling = (willing === '-- All Districts --' || row['Willing District'] === willing);
        return matchesDesignation && matchesWorking && matchesWilling;
      });

      const tbody = $('#transferTable tbody');
      tbody.empty();

      if (filteredData.length === 0) {
        tbody.append('<tr><td colspan="9" class="text-center">No matching requests found.</td></tr>');
        return;
      }
      
      filteredData.forEach(row => {
        const actionButton = row.MATCH_STATUS === 'MATCH FOUND' 
          ? `<button class="btn btn-success btn-sm" onclick="showContact(${row.id})">View Contact</button>`
          : `<button class="btn btn-outline-primary btn-sm" disabled>Pending</button>`;
        
        tbody.append(`
          <tr>
            <td>${row['Your Designation']}</td>
            <td>${row['Working District']}</td>
            <td>${row['Willing District']}</td>
            <td>${row['Date of Joining (DD-MM-YYYY)']}</td>
            <td>${row['Probation Declared?']}</td>
            <td>${row['COA Completed?']}</td>
            <td>${row['DEMAND_STATUS']}</td>
            <td>${row.MATCH_STATUS}</td>
            <td class="action-cell">${actionButton}</td>
          </tr>
        `);
      });
    }

    // 7. Clear Filters
    function clearFilters() {
      $('#filterDesignation').val('-- All Designations --');
      $('#filterWorking').val('-- All Districts --');
      $('#filterWilling').val('-- All Districts --');
      filterTable();
    }
    
    // 8. Handle Contact Button Click
    function showContact(rowId) {
      $('#contactName').text('Loading...');
      $('#contactNumber').text('Loading...');
      
      google.script.run
        .withSuccessHandler(displayContact)
        .withFailureHandler(handleContactError)
        .getPrivateContact(rowId);
      
      $('#contactModal').modal('show');
    }

    // 9. Display Contact Details in Modal
    function displayContact(contactDetails) {
      $('#contactName').text(contactDetails.name);
      $('#contactNumber').text(contactDetails.contact);
    }

    // 10. Handle Contact Access Errors (Security)
    function handleContactError(error) {
      console.error("Contact Error:", error);
      $('#contactName').text('Access Denied');
      $('#contactNumber').text(error.message || 'You are not authorized to view this contact yet.');
    }

    // 11. Handle General Error
    function handleError(error) {
      console.error("General Error:", error);
      $('#loading').html('<p class="text-danger">An error occurred while loading data: ' + error.message + '</p>');
    }
    
  </script>
</body>
</html>
